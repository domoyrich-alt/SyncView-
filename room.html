<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–ö–æ–º–Ω–∞—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - WatchParty</title>
    <link rel="stylesheet" href="style.css?v=2.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.10/dist/hls.min.js"></script>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="logo">
                <i class="fas fa-film"></i>
                <a href="/dashboard" style="text-decoration: none; color: inherit;">
                    <span>WatchParty</span>
                </a>
            </div>
            <div class="room-info-nav">
                <span id="roomNameNav">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                <div class="room-status-nav">
                    <i class="fas fa-circle online"></i>
                    <span id="participantsCount">0</span> –æ–Ω–ª–∞–π–Ω
                </div>
            </div>
            <div class="user-menu">
                <a href="/profile" class="user-profile-link">
                    <div class="user-avatar-nav" id="userAvatarNav"></div>
                    <span id="userNameNav"></span>
                </a>
                <button onclick="leaveRoom()" class="btn btn-outline btn-small">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                </button>
            </div>
        </nav>

        <div class="room-container">
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä -->
            <div class="video-section">
                <div class="video-wrapper">
                    <video id="videoPlayer" controls crossorigin="anonymous">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.
                    </video>
                    <div class="video-controls-overlay">
                        <div class="video-controls">
                            <button class="control-btn-large" id="playPauseBtn">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="time-display">
                                <span id="currentTime">00:00</span> / <span id="duration">00:00</span>
                            </div>
                            <input type="range" id="progressBar" class="progress-bar" min="0" max="100" value="0">
                            <div class="volume-control">
                                <button class="control-btn-small" id="muteBtn">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <input type="range" id="volumeBar" class="volume-bar" min="0" max="100" value="100">
                            </div>
                            <button class="control-btn-large" id="fullscreenBtn">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="video-url-input">
                    <input type="url" id="videoUrlInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (YouTube, Vimeo, MP4, M3U8)">
                    <button class="btn btn-primary" id="loadVideoBtn">
                        <i class="fas fa-play"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                </div>
            </div>

            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="sidebar">
                <!-- –ß–∞—Ç -->
                <div class="chat-container">
                    <div class="chat-header">
                        <h3><i class="fas fa-comments"></i> –ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã</h3>
                        <div class="chat-actions">
                            <button class="btn-icon" id="clearChatBtn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
                        <button class="btn btn-primary" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
                <div class="participants-container">
                    <div class="participants-header">
                        <h3><i class="fas fa-users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                        <span class="participants-count" id="participantsListCount">0</span>
                    </div>
                    <div class="participants-list" id="participantsList">
                        <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>

                <!-- –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
                <div class="sound-effects-panel">
                    <h3><i class="fas fa-music"></i> –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</h3>
                    <div class="sound-effects-grid">
                        <button class="sound-effect-btn" data-sound="applause">
                            <i class="fas fa-hands-clapping"></i>
                            <span>–ê–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç—ã</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="laugh">
                            <i class="fas fa-face-laugh"></i>
                            <span>–°–º–µ—Ö</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="gasp">
                            <i class="fas fa-face-surprise"></i>
                            <span>–£–¥–∏–≤–ª–µ–Ω–∏–µ</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="boo">
                            <i class="fas fa-face-angry"></i>
                            <span>–ù–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="drumroll">
                            <i class="fas fa-drum"></i>
                            <span>–ë–∞—Ä–∞–±–∞–Ω–Ω–∞—è –¥—Ä–æ–±—å</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="sad">
                            <i class="fas fa-face-sad-cry"></i>
                            <span>–ì—Ä—É—Å—Ç—å</span>
                        </button>
                    </div>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–æ–π -->
                <div class="room-control-panel">
                    <h3><i class="fas fa-cog"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–æ–π</h3>
                    <div class="room-controls">
                        <button class="btn btn-outline btn-block" id="inviteBtn">
                            <i class="fas fa-user-plus"></i> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π
                        </button>
                        
                        <!-- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞ -->
                        <button class="btn btn-primary btn-block" id="screenShareBtn">
                            <i class="fas fa-desktop"></i> –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
                        </button>
                        
                        <button class="btn btn-primary btn-block" id="syncBtn">
                            <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        
                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
                        <div class="sync-options">
                            <label class="setting">
                                <input type="checkbox" id="autoSync" checked>
                                <span class="checkmark"></span>
                                –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                            </label>
                            <label class="setting">
                                <input type="checkbox" id="syncAudio" checked>
                                <span class="checkmark"></span>
                                –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–≤—É–∫
                            </label>
                            <label class="setting">
                                <input type="checkbox" id="showControlBar" checked>
                                <span class="checkmark"></span>
                                –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                            </label>
                            <label class="setting">
                                <input type="checkbox" id="showTimestamps">
                                <span class="checkmark"></span>
                                –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Ä–µ–º—è –≤ —á–∞—Ç–µ
                            </label>
                        </div>
                        
                        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
                        <div class="sync-params">
                            <div class="sync-param">
                                <label for="syncDelay">–ó–∞–¥–µ—Ä–∂–∫–∞ (–º—Å):</label>
                                <input type="number" id="syncDelay" min="0" max="5000" value="100" step="100">
                            </div>
                            <div class="sync-param">
                                <label for="syncQuality">–ö–∞—á–µ—Å—Ç–≤–æ:</label>
                                <select id="syncQuality">
                                    <option value="low">–ù–∏–∑–∫–æ–µ</option>
                                    <option value="medium" selected>–°—Ä–µ–¥–Ω–µ–µ</option>
                                    <option value="high">–í—ã—Å–æ–∫–æ–µ</option>
                                    <option value="ultra">–£–ª—å—Ç—Ä–∞</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
    <div class="modal" id="inviteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</h3>
                <button class="modal-close" onclick="closeInviteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="invite-method">
                    <h4>–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h4>
                    <div class="link-container">
                        <input type="text" id="roomLink" readonly>
                        <button class="btn btn-primary" id="copyLinkBtn">
                            <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                    <p class="hint">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º, —á—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ</p>
                </div>
                
                <div class="invite-method">
                    <h4>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–æ email</h4>
                    <div class="email-invite">
                        <input type="email" id="inviteEmail" placeholder="Email –¥—Ä—É–≥–∞">
                        <button class="btn btn-primary" id="sendInviteBtn">
                            <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞ -->
    <div class="sync-notification" id="syncNotification" style="display: none;">
        <div class="sync-indicator">
            <i class="fas fa-desktop"></i>
            <span id="syncIndicatorText">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
        </div>
        <div class="sync-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="syncProgress"></div>
            </div>
            <span id="syncLatency">0–º—Å</span>
        </div>
        <button class="btn-icon" onclick="stopScreenShare()" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞">
            <i class="fas fa-stop"></i>
        </button>
    </div>

    <div id="notification" class="notification" style="display: none;"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="script.js?v=2.0"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket = null;
        let currentRoom = null;
        let currentUser = null;
        let isHost = false;
        let videoPlayer = null;
        let hls = null;
        let lastSyncTime = 0;
        let autoSyncEnabled = true;
        let isSyncing = false;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        let screenStream = null;
        let screenShareActive = false;
        let screenRecorder = null;
        let syncInterval = null;
        let syncQuality = 'medium';
        let syncDelay = 100;
        let currentScreenSharerId = null;
        let screenCanvas = null;
        let screenCtx = null;
        let progressInterval = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserData();
            await loadRoomData();
            initializeSocket();
            initializeVideoPlayer();
            setupEventListeners();
            initializeScreenCanvas();
        });

        async function loadUserData() {
            try {
                const response = await fetch('/api/user');
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('userNameNav').textContent = currentUser.username;
                    const avatarNav = document.getElementById('userAvatarNav');
                    avatarNav.style.backgroundImage = `url('${currentUser.avatar}')`;
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                window.location.href = '/login';
            }
        }

        async function loadRoomData() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = window.location.pathname.split('/').pop();
            const password = urlParams.get('password');
            
            try {
                let url = `/api/room/${roomId}`;
                if (password) {
                    url += `?password=${encodeURIComponent(password)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    currentRoom = data.room;
                    isHost = currentRoom.hostId === currentUser.id;
                    currentScreenSharerId = currentRoom.screenSharer ? currentRoom.screenSharer.userId : null;
                    updateRoomUI();
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç—ã', 'error');
                    setTimeout(() => window.location.href = '/dashboard', 2000);
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                setTimeout(() => window.location.href = '/dashboard', 2000);
            }
        }

        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                joinRoom();
            });
            
            socket.on('room-state', (data) => {
                console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:', data);
                currentScreenSharerId = data.screenSharer ? data.screenSharer.userId : null;
                updateParticipantsList(data.participants);
                loadChatMessages(data.messages);
                
                if (data.videoState.url) {
                    loadVideo(data.videoState.url);
                    if (!isHost && data.videoState.isPlaying !== undefined) {
                        syncVideoWithServer(data.videoState);
                    }
                }
                
                // –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç–∫—Ä–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                if (currentScreenSharerId && currentScreenSharerId !== currentUser.id) {
                    const sharer = data.participants.find(p => p.id === currentScreenSharerId);
                    if (sharer) {
                        showSyncNotification(sharer.username);
                    }
                }
            });
            
            socket.on('user-joined', (data) => {
                showNotification(`${data.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è(–∞—Å—å) –∫ –∫–æ–º–Ω–∞—Ç–µ`, 'info');
                addSystemMessage(`${data.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è(–∞—Å—å) –∫ –∫–æ–º–Ω–∞—Ç–µ`);
            });
            
            socket.on('user-left', (data) => {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É', 'info');
                removeParticipant(data.userId);
            });
            
            socket.on('new-message', (message) => {
                addMessageToChat(message);
            });
            
            socket.on('video-update', (data) => {
                if (isHost) return; // –•–æ—Å—Ç –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å —Å–æ–±–æ–π
                
                console.log('–ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ:', data);
                handleVideoUpdate(data);
            });
            
            socket.on('play-sound', (sound) => {
                playSoundEffect(sound);
            });
            
            socket.on('participants-updated', (participants) => {
                updateParticipantsList(participants);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
            socket.on('screen-share-start', (data) => {
                handleScreenShareStart(data);
            });
            
            socket.on('screen-share-stop', (data) => {
                handleScreenShareStop(data);
            });
            
            socket.on('screen-frame', (data) => {
                if (data.userId === currentUser.id) return;
                displayScreenFrame(data.frame, data.width, data.height);
            });
            
            socket.on('error', (data) => {
                showNotification(data.message, 'error');
            });
            
            socket.on('disconnect', () => {
                showNotification('–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            });
        }

        function joinRoom() {
            if (!socket || !currentRoom || !currentUser) return;
            
            socket.emit('join-room', {
                roomId: currentRoom.id,
                userId: currentUser.id,
                username: currentUser.username,
                avatar: currentUser.avatar
            });
        }

        function initializeVideoPlayer() {
            videoPlayer = document.getElementById('videoPlayer');
            
            // –°–æ–±—ã—Ç–∏—è –≤–∏–¥–µ–æ
            videoPlayer.addEventListener('play', () => {
                if (isHost) {
                    sendVideoControl('play', videoPlayer.currentTime);
                }
            });
            
            videoPlayer.addEventListener('pause', () => {
                if (isHost) {
                    sendVideoControl('pause', videoPlayer.currentTime);
                }
            });
            
            videoPlayer.addEventListener('seeked', () => {
                if (isHost && !isSyncing) {
                    sendVideoControl('seek', videoPlayer.currentTime);
                }
            });
            
            videoPlayer.addEventListener('timeupdate', () => {
                updateTimeDisplay();
                
                // –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –Ω–µ-—Ö–æ—Å—Ç–æ–≤
                if (!isHost && autoSyncEnabled && Date.now() - lastSyncTime > 10000) {
                    requestSync();
                }
            });
            
            videoPlayer.addEventListener('loadedmetadata', () => {
                updateTimeDisplay();
                if (isHost && currentRoom.videoUrl) {
                    sendVideoControl('change-video', 0, currentRoom.videoUrl);
                }
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HLS.js
            if (Hls.isSupported()) {
                hls = new Hls();
            }
        }

        function initializeScreenCanvas() {
            screenCanvas = document.createElement('canvas');
            screenCtx = screenCanvas.getContext('2d');
        }

        function setupEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ
            document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
            document.getElementById('muteBtn').addEventListener('click', toggleMute);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            
            document.getElementById('progressBar').addEventListener('input', (e) => {
                if (!videoPlayer.duration) return;
                const time = (e.target.value / 100) * videoPlayer.duration;
                videoPlayer.currentTime = time;
            });
            
            document.getElementById('volumeBar').addEventListener('input', (e) => {
                videoPlayer.volume = e.target.value / 100;
                updateVolumeIcon();
            });
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
            document.getElementById('loadVideoBtn').addEventListener('click', () => {
                const url = document.getElementById('videoUrlInput').value;
                if (url) {
                    loadVideo(url);
                    if (isHost) {
                        sendVideoControl('change-video', 0, url);
                    }
                }
            });
            
            document.getElementById('videoUrlInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('loadVideoBtn').click();
                }
            });
            
            // –ß–∞—Ç
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('clearChatBtn').addEventListener('click', () => {
                if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
                    document.getElementById('chatMessages').innerHTML = '';
                }
            });
            
            // –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            document.querySelectorAll('.sound-effect-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sound = btn.dataset.sound;
                    playSoundEffect(sound);
                    socket.emit('sound-effect', { roomId: currentRoom.id, sound });
                });
            });
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–æ–π
            document.getElementById('inviteBtn').addEventListener('click', openInviteModal);
            document.getElementById('syncBtn').addEventListener('click', requestSync);
            document.getElementById('screenShareBtn').addEventListener('click', () => {
                if (!screenShareActive) {
                    startScreenShare();
                } else {
                    stopScreenShare();
                }
            });
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            document.getElementById('autoSync').addEventListener('change', (e) => {
                autoSyncEnabled = e.target.checked;
            });
            
            document.getElementById('syncQuality').addEventListener('change', (e) => {
                syncQuality = e.target.value;
                if (screenShareActive) {
                    restartScreenSync();
                }
            });
            
            document.getElementById('syncDelay').addEventListener('change', (e) => {
                syncDelay = parseInt(e.target.value);
                if (screenShareActive) {
                    restartScreenSync();
                }
            });
            
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
            document.getElementById('copyLinkBtn').addEventListener('click', copyRoomLink);
            document.getElementById('sendInviteBtn').addEventListener('click', sendEmailInvite);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', () => {
                if (socket) {
                    socket.emit('leave-room', {
                        roomId: currentRoom.id,
                        userId: currentUser.id
                    });
                }
                stopScreenShare();
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ
        function loadVideo(url) {
            if (!url) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º URL –≤ –∫–æ–º–Ω–∞—Ç–µ
            currentRoom.videoUrl = url;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –≤–∏–¥–µ–æ
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                loadYouTubeVideo(url);
            } else if (url.includes('vimeo.com')) {
                loadVimeoVideo(url);
            } else if (url.endsWith('.m3u8')) {
                loadHLSVideo(url);
            } else if (url.endsWith('.mp4') || url.endsWith('.webm') || url.endsWith('.ogg')) {
                loadDirectVideo(url);
            } else {
                showNotification('–§–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
            }
        }

        function loadDirectVideo(url) {
            videoPlayer.src = url;
            videoPlayer.load();
            showNotification('–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...', 'info');
        }

        function loadHLSVideo(url) {
            if (Hls.isSupported()) {
                if (hls) {
                    hls.destroy();
                }
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    videoPlayer.play();
                });
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                videoPlayer.src = url;
                videoPlayer.addEventListener('loadedmetadata', () => {
                    videoPlayer.play();
                });
            } else {
                showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HLS –≤–∏–¥–µ–æ', 'error');
            }
        }

        function loadYouTubeVideo(url) {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å YouTube API
            showNotification('YouTube –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...', 'info');
            // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            document.getElementById('videoUrlInput').value = url;
        }

        function loadVimeoVideo(url) {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Vimeo API
            showNotification('Vimeo –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...', 'info');
            document.getElementById('videoUrlInput').value = url;
        }

        function togglePlayPause() {
            if (videoPlayer.paused) {
                videoPlayer.play();
            } else {
                videoPlayer.pause();
            }
        }

        function toggleMute() {
            videoPlayer.muted = !videoPlayer.muted;
            updateVolumeIcon();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                videoPlayer.requestFullscreen().catch(err => {
                    console.log('–û—à–∏–±–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function updateTimeDisplay() {
            const currentTime = document.getElementById('currentTime');
            const duration = document.getElementById('duration');
            const progressBar = document.getElementById('progressBar');
            
            if (!isNaN(videoPlayer.duration)) {
                const currentMinutes = Math.floor(videoPlayer.currentTime / 60);
                const currentSeconds = Math.floor(videoPlayer.currentTime % 60);
                const durationMinutes = Math.floor(videoPlayer.duration / 60);
                const durationSeconds = Math.floor(videoPlayer.duration % 60);
                
                currentTime.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
                duration.textContent = `${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
                progressBar.value = (videoPlayer.currentTime / videoPlayer.duration) * 100;
            }
        }

        function updateVolumeIcon() {
            const muteBtn = document.getElementById('muteBtn');
            const volumeBar = document.getElementById('volumeBar');
            
            if (videoPlayer.muted || videoPlayer.volume === 0) {
                muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                volumeBar.value = 0;
            } else if (videoPlayer.volume < 0.5) {
                muteBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
                volumeBar.value = videoPlayer.volume * 100;
            } else {
                muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                volumeBar.value = videoPlayer.volume * 100;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !socket) return;
            
            socket.emit('send-message', {
                roomId: currentRoom.id,
                userId: currentUser.id,
                message: message
            });
            
            input.value = '';
            input.focus();
        }

        function addMessageToChat(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            const time = new Date(message.timestamp);
            const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            
            messageElement.innerHTML = `
                <div class="message-avatar">
                    <img src="${message.avatar}" alt="${message.username}">
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-username">${message.username}</span>
                        <span class="message-time">${timeString}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message.message)}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message system';
            
            const time = new Date();
            const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-username"><i class="fas fa-info-circle"></i> –°–∏—Å—Ç–µ–º–∞</span>
                        <span class="message-time">${timeString}</span>
                    </div>
                    <div class="message-text">${text}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function loadChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messages.forEach(message => {
                addMessageToChat(message);
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function updateParticipantsList(participants) {
            const participantsList = document.getElementById('participantsList');
            const participantsCount = document.getElementById('participantsCount');
            const participantsListCount = document.getElementById('participantsListCount');
            
            participantsList.innerHTML = '';
            participantsCount.textContent = participants.length;
            participantsListCount.textContent = participants.length;
            
            participants.forEach(participant => {
                const isSharing = participant.isSharingScreen || participant.id === currentScreenSharerId;
                const isCurrentUser = participant.id === currentUser.id;
                
                const participantElement = document.createElement('div');
                participantElement.className = 'participant-item';
                participantElement.innerHTML = `
                    <div class="participant-avatar">
                        <img src="${participant.avatar}" alt="${participant.username}">
                        ${isSharing ? '<div class="sharing-indicator"><i class="fas fa-desktop"></i></div>' : ''}
                    </div>
                    <div class="participant-info">
                        <div class="participant-name">
                            ${participant.username}
                            ${isCurrentUser ? '<span class="you-badge">–í—ã</span>' : ''}
                            ${isSharing ? '<span class="sharing-badge">–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç</span>' : ''}
                        </div>
                        ${participant.id === currentRoom.hostId ? 
                          '<div class="participant-host">–•–æ—Å—Ç</div>' : 
                          '<div class="participant-role">–£—á–∞—Å—Ç–Ω–∏–∫</div>'}
                    </div>
                `;
                participantsList.appendChild(participantElement);
            });
        }

        function removeParticipant(userId) {
            // –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket —Å–æ–±—ã—Ç–∏—è
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function sendVideoControl(action, time, url) {
            if (!socket) return;
            
            socket.emit('video-control', {
                roomId: currentRoom.id,
                action: action,
                time: time,
                url: url
            });
            
            lastSyncTime = Date.now();
        }

        function handleVideoUpdate(data) {
            isSyncing = true;
            
            switch(data.action) {
                case 'play':
                    if (Math.abs(videoPlayer.currentTime - data.time) > 2) {
                        videoPlayer.currentTime = data.time;
                    }
                    videoPlayer.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
                    break;
                case 'pause':
                    videoPlayer.pause();
                    if (Math.abs(videoPlayer.currentTime - data.time) > 2) {
                        videoPlayer.currentTime = data.time;
                    }
                    break;
                case 'seek':
                    videoPlayer.currentTime = data.time;
                    break;
                case 'change-video':
                    loadVideo(data.url);
                    break;
            }
            
            setTimeout(() => {
                isSyncing = false;
            }, 100);
        }

        function requestSync() {
            if (!socket || !isHost) return;
            
            socket.emit('video-control', {
                roomId: currentRoom.id,
                action: videoPlayer.paused ? 'pause' : 'play',
                time: videoPlayer.currentTime
            });
            
            lastSyncTime = Date.now();
            showNotification('–í–∏–¥–µ–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'info');
        }

        // –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        function playSoundEffect(sound) {
            const audio = new Audio();
            
            switch(sound) {
                case 'applause':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-audience-light-applause-354.mp3';
                    break;
                case 'laugh':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-crowd-laugh-464.mp3';
                    break;
                case 'gasp':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-crowd-gasp-390.mp3';
                    break;
                case 'boo':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-boo-crowd-461.mp3';
                    break;
                case 'drumroll':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-drum-roll-473.mp3';
                    break;
                case 'sad':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-sad-crowd-492.mp3';
                    break;
            }
            
            audio.volume = 0.3;
            audio.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', e));
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        async function startScreenShare() {
            try {
                showNotification('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —ç–∫—Ä–∞–Ω—É...', 'info');
                
                const constraints = {
                    video: {
                        cursor: "always",
                        frameRate: getFrameRate(),
                        width: { max: getMaxWidth() },
                        height: { max: getMaxHeight() }
                    },
                    audio: document.getElementById('syncAudio').checked
                };
                
                screenStream = await navigator.mediaDevices.getDisplayMedia(constraints);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏
                screenStream.getVideoTracks()[0].onended = () => {
                    stopScreenShare();
                };
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —ç–∫—Ä–∞–Ω –≤ –≤–∏–¥–µ–æ-–ø–ª–µ–µ—Ä–µ
                videoPlayer.srcObject = screenStream;
                videoPlayer.muted = true; // –û—Ç–∫–ª—é—á–∞–µ–º –∑–≤—É–∫ —É –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('screenShareBtn').innerHTML = '<i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∫–∞–∑';
                document.getElementById('screenShareBtn').classList.remove('btn-primary');
                document.getElementById('screenShareBtn').classList.add('btn-danger');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                document.getElementById('syncIndicatorText').textContent = '–í—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç–µ —ç–∫—Ä–∞–Ω';
                document.getElementById('syncNotification').style.display = 'flex';
                startProgressAnimation();
                
                // –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                startScreenSync();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
                currentScreenSharerId = currentUser.id;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø–æ–∫–∞–∑–∞ —ç–∫—Ä–∞–Ω–∞
                socket.emit('screen-share-start', {
                    roomId: currentRoom.id,
                    userId: currentUser.id,
                    username: currentUser.username,
                    quality: syncQuality,
                    delay: syncDelay
                });
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —á–∞—Ç
                socket.emit('send-message', {
                    roomId: currentRoom.id,
                    userId: currentUser.id,
                    message: 'üî¥ –ù–∞—á–∞–ª –ø–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞'
                });
                
                showNotification('–ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –Ω–∞—á–∞—Ç', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —ç–∫—Ä–∞–Ω–∞:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –ø–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞', 'error');
                
                if (error.name === 'NotAllowedError') {
                    showNotification('–î–æ—Å—Ç—É–ø –∫ —ç–∫—Ä–∞–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                }
            }
        }

        function startScreenSync() {
            screenShareActive = true;
            syncQuality = document.getElementById('syncQuality').value;
            syncDelay = parseInt(document.getElementById('syncDelay').value);
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            if (syncInterval) clearInterval(syncInterval);
            
            // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞—Ö–≤–∞—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∫—É –∫–∞–¥—Ä–æ–≤
            syncInterval = setInterval(() => {
                captureAndSendScreenFrame();
            }, syncDelay);
        }

        function captureAndSendScreenFrame() {
            if (!screenStream || !screenCanvas || !screenCtx) return;
            
            try {
                const videoTrack = screenStream.getVideoTracks()[0];
                if (!videoTrack) return;
                
                const videoSettings = videoTrack.getSettings();
                if (!videoSettings.width || !videoSettings.height) return;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas
                const scale = getQualityScale(syncQuality);
                screenCanvas.width = videoSettings.width * scale;
                screenCanvas.height = videoSettings.height * scale;
                
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π video —ç–ª–µ–º–µ–Ω—Ç
                const tempVideo = document.createElement('video');
                tempVideo.srcObject = new MediaStream([videoTrack]);
                
                tempVideo.onloadeddata = () => {
                    // –†–∏—Å—É–µ–º –∫–∞–¥—Ä –Ω–∞ canvas
                    screenCtx.drawImage(tempVideo, 0, 0, screenCanvas.width, screenCanvas.height);
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
                    const frameData = screenCanvas.toDataURL('image/jpeg', getQualityCompression(syncQuality));
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–¥—Ä –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
                    socket.emit('screen-frame', {
                        roomId: currentRoom.id,
                        userId: currentUser.id,
                        frame: frameData,
                        timestamp: Date.now(),
                        width: screenCanvas.width,
                        height: screenCanvas.height
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–µ—Ä–∂–∫–∏
                    updateLatencyIndicator();
                };
                
                tempVideo.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ:', e));
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–¥—Ä–∞:', error);
            }
        }

        function displayScreenFrame(frameData, width, height) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Ç–æ–∫ —Å —ç–∫—Ä–∞–Ω–∞, –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞–¥—Ä—ã
            if (screenShareActive) return;
            
            const img = new Image();
            img.onload = () => {
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = width;
                tempCanvas.height = height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(img, 0, 0, width, height);
                
                // –°–æ–∑–¥–∞–µ–º –≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫ –∏–∑ canvas
                const stream = tempCanvas.captureStream(30);
                if (videoPlayer.srcObject !== stream) {
                    videoPlayer.srcObject = stream;
                }
            };
            img.src = frameData;
        }

        function handleScreenShareStart(data) {
            if (data.userId === currentUser.id) return;
            
            currentScreenSharerId = data.userId;
            
            showSyncNotification(data.username);
            showNotification(`${data.username} –Ω–∞—á–∞–ª –ø–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞`, 'info');
        }

        function handleScreenShareStop(data) {
            if (data.userId === currentUser.id) return;
            
            if (currentScreenSharerId === data.userId) {
                currentScreenSharerId = null;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                document.getElementById('syncNotification').style.display = 'none';
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
                showNotification('–ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
            }
        }

        function stopScreenShare() {
            if (screenShareActive) {
                screenShareActive = false;
                currentScreenSharerId = null;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                if (syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = null;
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                    screenStream = null;
                }
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–µ–æ –ø–ª–µ–µ—Ä –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                videoPlayer.srcObject = null;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('screenShareBtn').innerHTML = '<i class="fas fa-desktop"></i> –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω';
                document.getElementById('screenShareBtn').classList.remove('btn-danger');
                document.getElementById('screenShareBtn').classList.add('btn-primary');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                document.getElementById('syncNotification').style.display = 'none';
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
                socket.emit('screen-share-stop', {
                    roomId: currentRoom.id,
                    userId: currentUser.id
                });
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —á–∞—Ç
                socket.emit('send-message', {
                    roomId: currentRoom.id,
                    userId: currentUser.id,
                    message: '‚èπÔ∏è –ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
                });
                
                showNotification('–ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
            }
        }

        function showSyncNotification(username) {
            document.getElementById('syncIndicatorText').textContent = `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å ${username}`;
            document.getElementById('syncNotification').style.display = 'flex';
            startProgressAnimation();
        }

        function startProgressAnimation() {
            let progress = 0;
            const progressBar = document.getElementById('syncProgress');
            
            if (progressInterval) clearInterval(progressInterval);
            
            progressInterval = setInterval(() => {
                progress = (progress + 5) % 100;
                progressBar.style.width = `${progress}%`;
            }, 100);
        }

        function updateLatencyIndicator() {
            const latencyElement = document.getElementById('syncLatency');
            const latency = Math.floor(Math.random() * 50) + 20; // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ 20-70–º—Å
            latencyElement.textContent = `${latency}–º—Å`;
        }

        function restartScreenSync() {
            if (screenShareActive) {
                stopScreenShare();
                setTimeout(() => startScreenShare(), 100);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞
        function getQualityScale(quality) {
            switch(quality) {
                case 'low': return 0.3;
                case 'medium': return 0.5;
                case 'high': return 0.7;
                case 'ultra': return 1;
                default: return 0.5;
            }
        }

        function getQualityCompression(quality) {
            switch(quality) {
                case 'low': return 0.3;
                case 'medium': return 0.6;
                case 'high': return 0.8;
                case 'ultra': return 1;
                default: return 0.6;
            }
        }

        function getFrameRate() {
            const quality = document.getElementById('syncQuality').value;
            switch(quality) {
                case 'low': return 10;
                case 'medium': return 15;
                case 'high': return 24;
                case 'ultra': return 30;
                default: return 15;
            }
        }

        function getMaxWidth() {
            const quality = document.getElementById('syncQuality').value;
            switch(quality) {
                case 'low': return 1280;
                case 'medium': return 1920;
                case 'high': return 2560;
                case 'ultra': return 3840;
                default: return 1920;
            }
        }

        function getMaxHeight() {
            const quality = document.getElementById('syncQuality').value;
            switch(quality) {
                case 'low': return 720;
                case 'medium': return 1080;
                case 'high': return 1440;
                case 'ultra': return 2160;
                default: return 1080;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ UI
        function updateRoomUI() {
            document.getElementById('roomNameNav').textContent = currentRoom.name;
            document.title = `${currentRoom.name} - WatchParty`;
            
            if (currentRoom.videoUrl) {
                document.getElementById('videoUrlInput').value = currentRoom.videoUrl;
                loadVideo(currentRoom.videoUrl);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            document.getElementById('autoSync').checked = autoSyncEnabled;
            document.getElementById('syncQuality').value = syncQuality;
            document.getElementById('syncDelay').value = syncDelay;
            
            updateParticipantsList(currentRoom.participants || []);
        }

        function openInviteModal() {
            document.getElementById('inviteModal').classList.add('active');
            document.getElementById('roomLink').value = `${window.location.origin}/room/${currentRoom.id}`;
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').classList.remove('active');
        }

        async function copyRoomLink() {
            const linkInput = document.getElementById('roomLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            try {
                await navigator.clipboard.writeText(linkInput.value);
                showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            } catch (err) {
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            }
        }

        function sendEmailInvite() {
            const email = document.getElementById('inviteEmail').value;
            if (!email) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ email', 'error');
                return;
            }
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ API
            showNotification(`–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ${email}`, 'success');
            document.getElementById('inviteEmail').value = '';
        }

        function leaveRoom() {
            stopScreenShare();
            
            if (socket) {
                socket.emit('leave-room', {
                    roomId: currentRoom.id,
                    userId: currentUser.id
                });
            }
            window.location.href = '/dashboard';
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        window.togglePlayPause = togglePlayPause;
        window.toggleMute = toggleMute;
        window.toggleFullscreen = toggleFullscreen;
        window.sendMessage = sendMessage;
        window.leaveRoom = leaveRoom;
        window.openInviteModal = openInviteModal;
        window.closeInviteModal = closeInviteModal;
        window.copyRoomLink = copyRoomLink;
        window.requestSync = requestSync;
        window.startScreenShare = startScreenShare;
        window.stopScreenShare = stopScreenShare;
    </script>
</body>
</html>