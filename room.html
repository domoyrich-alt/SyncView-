<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WatchParty - –ö–æ–º–Ω–∞—Ç–∞</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.0.10/hls.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://www.youtube.com/iframe_api"></script> <!-- –î–ª—è YouTube API -->
<style>
body {
background: #000000; /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
font-family: 'Arial', sans-serif;
color: #ffffff; /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
margin: 0;
padding: 0;
}
#loadingOverlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.8); /* –¢–µ–º–Ω—ã–π overlay */
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
z-index: 9999;
}
#loadingText {
font-size: 18px;
color: #ff8c00; /* –¢–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ü–≤–µ—Ç */
}
.nav-bar {
background-color: #ff8c00; /* –¢–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ö–µ–¥–µ—Ä */
color: #000000; /* –ß–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
padding: 10px;
display: flex;
justify-content: space-between;
align-items: center;
}
.nav-bar h2 {
margin: 0;
}
.user-info {
display: flex;
align-items: center;
}
.user-avatar {
width: 30px;
height: 30px;
border-radius: 50%;
background-color: #333333; /* –¢–µ–º–Ω—ã–π —Å–µ—Ä—ã–π –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ */
margin-right: 10px;
}
.main-container {
display: flex;
height: calc(100vh - 50px);
}
.video-section {
flex: 3;
padding: 10px;
background-color: #111111; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –≤–∏–¥–µ–æ */
border-radius: 8px;
box-shadow: 0 2px 10px rgba(255, 140, 0, 0.3); /* –¢–µ–Ω—å —Å –æ—Ä–∞–Ω–∂–µ–≤—ã–º –æ—Ç—Ç–µ–Ω–∫–æ–º */
}
#videoPlayer {
width: 100%;
height: 400px;
background-color: #000000;
border-radius: 8px;
}
.controls {
display: flex;
justify-content: space-around;
margin-top: 10px;
}
.btn {
padding: 8px 16px;
border: none;
border-radius: 4px;
cursor: pointer;
color: #000000; /* –ß–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö */
}
.btn-primary {
background-color: #ff8c00; /* –¢–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π */
}
.btn-danger {
background-color: #b22222; /* –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π –¥–ª—è danger */
}
.btn-success {
background-color: #ff8c00; /* –¢–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è success */
}
.chat-section, .participants-section {
flex: 1;
padding: 10px;
background-color: #111111; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
border-left: 1px solid #333333;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(255, 140, 0, 0.3);
}
#chatMessages {
height: 300px;
overflow-y: auto;
padding: 10px;
background-color: #222222; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —á–∞—Ç */
border-radius: 4px;
}
.chat-message {
margin-bottom: 10px;
display: flex;
align-items: flex-start;
}
.message-avatar img {
width: 40px;
height: 40px;
border-radius: 50%;
}
.message-content {
margin-left: 10px;
}
.system {
color: #ff8c00; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
}
#notification {
position: fixed;
bottom: 20px;
right: 20px;
padding: 10px 20px;
border-radius: 4px;
display: none;
}
.info { background-color: #ff8c00; color: #000000; }
.success { background-color: #ff8c00; color: #000000; }
.error { background-color: #b22222; color: #ffffff; }
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª–æ–≤ –∏ —Ç.–¥. */
#inviteModal {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: #111111; /* –¢–µ–º–Ω—ã–π –º–æ–¥–∞–ª */
padding: 20px;
border-radius: 8px;
box-shadow: 0 0 20px rgba(255, 140, 0, 0.5);
display: none;
color: #ffffff;
}
#inviteModal.active { display: block; }
</style>
</head>
<body>
<div id="loadingOverlay">
<i class="fas fa-spinner fa-spin fa-3x" style="color: #ff8c00;"></i>
<p id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
<nav class="nav-bar">
<h2 id="roomNameNav">–ö–æ–º–Ω–∞—Ç–∞</h2>
<div class="user-info">
<div id="userAvatarNav" class="user-avatar"></div>
<span id="userNameNav">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
</div>
</nav>
<div class="main-container">
<div class="video-section">
<video id="videoPlayer" controls></video>
<div class="controls">
<button id="playPauseBtn" class="btn btn-primary"><i class="fas fa-play"></i> –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏/–ü–∞—É–∑–∞</button>
<button id="muteBtn" class="btn btn-primary"><i class="fas fa-volume-up"></i></button>
<button id="fullscreenBtn" class="btn btn-primary"><i class="fas fa-expand"></i></button>
<button id="loadVideoBtn" class="btn btn-success"><i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
<button id="screenShareBtn" class="btn btn-primary"><i class="fas fa-desktop"></i> –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω</button>
<button id="inviteBtn" class="btn btn-primary"><i class="fas fa-user-plus"></i> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
</div>
<input type="text" id="videoUrlInput" placeholder="URL –≤–∏–¥–µ–æ" style="background-color: #222222; color: #ffffff; border: 1px solid #ff8c00;">
<div id="syncNotification" style="display: none; color: #ff8c00;">
<span id="syncIndicatorText"></span>
</div>
</div>
<div class="chat-section">
<h3>–ß–∞—Ç <span id="participantsCount">0</span></h3>
<div id="chatMessages"></div>
<input type="text" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="background-color: #222222; color: #ffffff; border: 1px solid #ff8c00;">
<button id="sendMessageBtn" class="btn btn-success"><i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>
<div class="participants-section">
<h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ <span id="participantsListCount">0</span></h3>
<div id="participantsList"></div>
</div>
</div>
<div id="inviteModal">
<h3>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ –∫–æ–º–Ω–∞—Ç—É</h3>
<input type="text" id="roomLink" readonly style="background-color: #222222; color: #ffffff; border: 1px solid #ff8c00;">
<button id="copyLinkBtn" class="btn btn-primary">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
<button onclick="closeInviteModal()" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
<div id="notification"></div>
  <script>
    const socket = io();
    let currentRoom = null;
    let currentUser = null;
    let isHost = false;
    let videoPlayer = null;
    let hls = null;
    let lastSyncTime = 0;
    let autoSyncEnabled = true;
    let isSyncing = false;
    let screenShareActive = false;
    let screenStream = null;
    let syncInterval = null;
    let progressInterval = null;
    let youtubePlayer = null;
    let isYouTube = false;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ YouTube API
    function loadYouTubeAPI() {
      if (typeof YT !== 'undefined') return;
      const tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ URL YouTube
    function isYouTubeUrl(url) {
      return url.includes('youtube.com/watch') || url.includes('youtu.be/');
    }

    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ ID YouTube
    function extractYouTubeId(url) {
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }

    window.onYouTubeIframeAPIReady = function() {};

    document.addEventListener('DOMContentLoaded', async () => {
      showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
      await loadUserData();
      showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç—ã...');
      await loadRoomData();
      initializeVideoPlayer();
      setupEventListeners();
      showLoading('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...');
      initializeSocket();
    });

    async function loadUserData() {
      try {
        const response = await fetch('/api/user', {
          credentials: 'include' // –í–ê–ñ–ù–û –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–µ—Å—Å–∏–π –Ω–∞ Render
        });
        console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        if (response.status === 401) {
          console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω');
          window.location.href = '/login';
          return;
        }
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data);
        if (data.success) {
          currentUser = data.user;
          document.getElementById('userNameNav').textContent = currentUser.username;
          const avatarNav = document.getElementById('userAvatarNav');
          if (currentUser.avatar) {
            avatarNav.style.backgroundImage = `url('${currentUser.avatar}')`;
            avatarNav.style.backgroundSize = 'cover';
            avatarNav.style.backgroundPosition = 'center';
          }
          console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', currentUser.username);
        } else {
          console.log('–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω');
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        window.location.href = '/login';
      }
    }

    async function loadRoomData() {
      const roomId = window.location.pathname.split('/').pop();
      try {
        const response = await fetch(`/api/room/${roomId}`);
        const data = await response.json();
        if (data.success) {
          currentRoom = data.room;
          isHost = currentRoom.hostId === currentUser.id;
          updateRoomUI();
        } else {
          showNotification(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç—ã', 'error');
          setTimeout(() => window.location.href = '/dashboard', 2000);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç—ã:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        setTimeout(() => window.location.href = '/dashboard', 2000);
      }
    }

    function initializeSocket() {
      socket = io();
      socket.on('connect', () => {
        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        hideLoading();
        joinRoom();
      });
      socket.on('room-state', (data) => {
        console.log('üì¶ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã');
        updateParticipantsList(data.participants);
        loadChatMessages(data.messages);
        if (data.videoState.url && data.videoState.url !== currentRoom.videoUrl) {
          loadVideo(data.videoState.url);
        }
        if (!isHost && data.videoState.isPlaying !== undefined) {
          syncVideoWithServer(data.videoState);
        }
      });
      socket.on('user-joined', (data) => {
        showNotification(`${data.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è(–∞—Å—å)`, 'info');
        addSystemMessage(`${data.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è(–∞—Å—å) –∫ –∫–æ–º–Ω–∞—Ç–µ`);
      });
      socket.on('user-left', (data) => {
        addSystemMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É');
      });
      socket.on('new-message', (message) => {
        addMessageToChat(message);
      });
      socket.on('video-update', (data) => {
        if (isHost) return;
        handleVideoUpdate(data);
      });
      socket.on('play-sound', (sound) => {
        playSoundEffect(sound);
      });
      socket.on('participants-updated', (participants) => {
        updateParticipantsList(participants);
      });
      socket.on('error', (data) => {
        showNotification(data.message, 'error');
      });
      socket.on('connect_error', (error) => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
      });
    }

    function joinRoom() {
      if (!socket || !currentRoom || !currentUser) return;
      socket.emit('join-room', { roomId: currentRoom.id, userId: currentUser.id, username: currentUser.username, avatar: currentUser.avatar });
    }

    function initializeVideoPlayer() {
      loadYouTubeAPI();
      videoPlayer = document.getElementById('videoPlayer');
      videoPlayer.addEventListener('play', () => {
        if (isHost) {
          sendVideoControl('play', videoPlayer.currentTime);
        }
      });
      videoPlayer.addEventListener('pause', () => {
        if (isHost) {
          sendVideoControl('pause', videoPlayer.currentTime);
        }
      });
      videoPlayer.addEventListener('seeked', () => {
        if (isHost && !isSyncing) {
          sendVideoControl('seek', videoPlayer.currentTime);
        }
      });
      videoPlayer.addEventListener('timeupdate', () => {
        updateTimeDisplay();
      });
      if (Hls && Hls.isSupported()) {
        hls = new Hls({ enableWorker: false });
      }
    }

    function setupEventListeners() {
      document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
      document.getElementById('muteBtn').addEventListener('click', toggleMute);
      document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
      document.getElementById('loadVideoBtn').addEventListener('click', () => {
        const url = document.getElementById('videoUrlInput').value;
        if (url) {
          loadVideo(url);
          if (isHost) {
            sendVideoControl('change-video', 0, url);
          }
        }
      });
      document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      document.querySelectorAll('.sound-effect-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sound = btn.dataset.sound;
          playSoundEffect(sound);
          if (socket && currentRoom) {
            socket.emit('sound-effect', { roomId: currentRoom.id, sound });
          }
        });
      });
      document.getElementById('inviteBtn').addEventListener('click', openInviteModal);
      document.getElementById('screenShareBtn').addEventListener('click', toggleScreenShare);
      document.getElementById('copyLinkBtn').addEventListener('click', copyRoomLink);
      window.addEventListener('beforeunload', () => {
        if (socket && currentRoom && currentUser) {
          socket.emit('leave-room', { roomId: currentRoom.id, userId: currentUser.id });
        }
        stopScreenShare();
      });
    }

    function loadVideo(url) {
      if (!url) return;
      currentRoom.videoUrl = url;
      showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...', 'info');
      isYouTube = isYouTubeUrl(url);
      try {
        if (isYouTube) {
          const videoId = extractYouTubeId(url);
          if (!videoId) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π URL YouTube');
          const container = videoPlayer.parentNode;
          container.removeChild(videoPlayer);
          const iframeContainer = document.createElement('div');
          iframeContainer.id = 'youtubePlayer';
          iframeContainer.style.width = '100%';
          iframeContainer.style.height = '400px';
          container.appendChild(iframeContainer);
          youtubePlayer = new YT.Player('youtubePlayer', {
            height: '400',
            width: '100%',
            videoId: videoId,
            playerVars: { autoplay: 1, controls: 1, rel: 0, modestbranding: 1 },
            events: { onReady: onYouTubeReady, onStateChange: onYouTubeStateChange }
          });
        } else if (url.includes('.m3u8') && hls) {
          hls.loadSource(url);
          hls.attachMedia(videoPlayer);
          hls.on(Hls.Events.MANIFEST_PARSED, () => videoPlayer.play());
        } else {
          videoPlayer.src = url;
          videoPlayer.load();
          videoPlayer.play().catch(e => console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ:', e));
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ', 'error');
      }
    }

    function onYouTubeReady(event) {}

    function onYouTubeStateChange(event) {
      if (isHost) {
        let action, time = youtubePlayer.getCurrentTime();
        if (event.data === YT.PlayerState.PLAYING) action = 'play';
        else if (event.data === YT.PlayerState.PAUSED) action = 'pause';
        if (action) sendVideoControl(action, time);
      }
    }

    function togglePlayPause() {
      if (isYouTube) {
        if (youtubePlayer.getPlayerState() === YT.PlayerState.PLAYING) youtubePlayer.pauseVideo();
        else youtubePlayer.playVideo();
      } else {
        if (videoPlayer.paused) videoPlayer.play();
        else videoPlayer.pause();
      }
    }

    function toggleMute() {
      videoPlayer.muted = !videoPlayer.muted;
      updateVolumeIcon();
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        videoPlayer.requestFullscreen().catch(err => console.log('–û—à–∏–±–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞:', err));
      } else {
        document.exitFullscreen();
      }
    }

    function updateTimeDisplay() {
      // –í–∞—à –∫–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    }

    function updateVolumeIcon() {
      const muteBtn = document.getElementById('muteBtn');
      if (videoPlayer.muted || videoPlayer.volume === 0) {
        muteBtn.innerHTML = '';
      } else if (videoPlayer.volume < 0.5) {
        muteBtn.innerHTML = '';
      } else {
        muteBtn.innerHTML = '';
      }
    }

    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message || !socket) return;
      socket.emit('send-message', { roomId: currentRoom.id, userId: currentUser.id, message: message });
      input.value = '';
      input.focus();
    }

    function addMessageToChat(message) {
      const chatMessages = document.getElementById('chatMessages');
      const messageElement = document.createElement('div');
      messageElement.className = 'chat-message';
      const time = new Date(message.timestamp);
      const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
      messageElement.innerHTML = `
        
           $${message.username}
        
        
          
            ${escapeHtml(message.username)}
            ${timeString}
          
          ${escapeHtml(message.message)}
        
      `;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addSystemMessage(text) {
      const chatMessages = document.getElementById('chatMessages');
      const messageElement = document.createElement('div');
      messageElement.className = 'chat-message system';
      const time = new Date();
      const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
      messageElement.innerHTML = `
        
          
             –°–∏—Å—Ç–µ–º–∞
            ${timeString}
          
          ${escapeHtml(text)}
        
      `;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function loadChatMessages(messages) {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = ' –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç –∫–æ–º–Ω–∞—Ç—ã!';
      messages.forEach(message => addMessageToChat(message));
    }

    function updateParticipantsList(participants) {
      const participantsList = document.getElementById('participantsList');
      const participantsCount = document.getElementById('participantsCount');
      const participantsListCount = document.getElementById('participantsListCount');
      participantsList.innerHTML = '';
      participantsCount.textContent = participants.length;
      participantsListCount.textContent = participants.length;
      participants.forEach(participant => {
        const isCurrentUser = participant.id === currentUser.id;
        const participantElement = document.createElement('div');
        participantElement.className = 'participant-item';
        participantElement.innerHTML = `
          
             $${participant.username}
          
          
            
              ${escapeHtml(participant.username)} ${isCurrentUser ? '–í—ã' : ''}
            
            
              ${participant.id === currentRoom.hostId ? '–•–æ—Å—Ç' : '–£—á–∞—Å—Ç–Ω–∏–∫'}
            
          
        `;
        participantsList.appendChild(participantElement);
      });
    }

    function sendVideoControl(action, time, url) {
      if (!socket) return;
      socket.emit('video-control', { roomId: currentRoom.id, action: action, time: time, url: url });
      lastSyncTime = Date.now();
    }

    function handleVideoUpdate(data) {
      isSyncing = true;
      if (isYouTube) {
        switch(data.action) {
          case 'play': youtubePlayer.playVideo(); youtubePlayer.seekTo(data.time); break;
          case 'pause': youtubePlayer.pauseVideo(); youtubePlayer.seekTo(data.time); break;
          case 'seek': youtubePlayer.seekTo(data.time); break;
          case 'change-video': loadVideo(data.url); break;
        }
      } else {
        switch(data.action) {
          case 'play':
            if (Math.abs(videoPlayer.currentTime - data.time) > 2) videoPlayer.currentTime = data.time;
            videoPlayer.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
            break;
          case 'pause':
            videoPlayer.pause();
            if (Math.abs(videoPlayer.currentTime - data.time) > 2) videoPlayer.currentTime = data.time;
            break;
          case 'seek': videoPlayer.currentTime = data.time; break;
          case 'change-video': loadVideo(data.url); break;
        }
      }
      setTimeout(() => { isSyncing = false; }, 100);
    }

    function syncVideoWithServer(videoState) {
      if (isHost) return;
      if (Math.abs(videoPlayer.currentTime - videoState.currentTime) > 2) {
        videoPlayer.currentTime = videoState.currentTime;
      }
      if (videoState.isPlaying && videoPlayer.paused) {
        videoPlayer.play().catch(e => console.log('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', e));
      } else if (!videoState.isPlaying && !videoPlayer.paused) {
        videoPlayer.pause();
      }
    }

    function playSoundEffect(sound) {
      const sounds = {
        applause: 'https://assets.mixkit.co/sfx/preview/mixkit-audience-light-applause-354.mp3',
        laugh: 'https://assets.mixkit.co/sfx/preview/mixkit-crowd-laugh-464.mp3',
        gasp: 'https://assets.mixkit.co/sfx/preview/mixkit-crowd-gasp-390.mp3',
        boo: 'https://assets.mixkit.co/sfx/preview/mixkit-boo-crowd-461.mp3',
        drumroll: 'https://assets.mixkit.co/sfx/preview/mixkit-drum-roll-473.mp3',
        sad: 'https://assets.mixkit.co/sfx/preview/mixkit-sad-crowd-492.mp3'
      };
      if (sounds[sound]) {
        const audio = new Audio(sounds[sound]);
        audio.volume = 0.3;
        audio.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', e));
      }
    }

    async function toggleScreenShare() {
      if (!screenShareActive) {
        await startScreenShare();
      } else {
        stopScreenShare();
      }
    }

    async function startScreenShare() {
      try {
        showNotification('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —ç–∫—Ä–∞–Ω—É...', 'info');
        screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: document.getElementById('syncAudio').checked });
        videoPlayer.srcObject = screenStream;
        videoPlayer.muted = true;
        document.getElementById('screenShareBtn').innerHTML = ' –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∫–∞–∑';
        document.getElementById('screenShareBtn').classList.remove('btn-primary');
        document.getElementById('screenShareBtn').classList.add('btn-danger');
        document.getElementById('syncIndicatorText').textContent = '–í—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç–µ —ç–∫—Ä–∞–Ω';
        document.getElementById('syncNotification').style.display = 'flex';
        startProgressAnimation();
        screenShareActive = true;
        screenStream.getVideoTracks()[0].onended = () => stopScreenShare();
        showNotification('–ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –Ω–∞—á–∞—Ç', 'success');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —ç–∫—Ä–∞–Ω–∞:', error);
        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –ø–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞', 'error');
      }
    }

    function stopScreenShare() {
      if (screenShareActive) {
        screenShareActive = false;
        if (screenStream) {
          screenStream.getTracks().forEach(track => track.stop());
          screenStream = null;
        }
        videoPlayer.srcObject = null;
        if (currentRoom.videoUrl) loadVideo(currentRoom.videoUrl);
        document.getElementById('screenShareBtn').innerHTML = ' –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω';
        document.getElementById('screenShareBtn').classList.remove('btn-danger');
        document.getElementById('screenShareBtn').classList.add('btn-primary');
        document.getElementById('syncNotification').style.display = 'none';
        if (progressInterval) clearInterval(progressInterval);
        progressInterval = null;
        showNotification('–ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
      }
    }

    function startProgressAnimation() {
      let progress = 0;
      const progressBar = document.getElementById('syncProgress');
      if (progressInterval) clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        progress = (progress + 5) % 100;
        progressBar.style.width = `${progress}%`;
      }, 100);
    }

    function updateRoomUI() {
      document.getElementById('roomNameNav').textContent = currentRoom.name;
      document.title = `${currentRoom.name} - WatchParty`;
      if (currentRoom.videoUrl) {
        document.getElementById('videoUrlInput').value = currentRoom.videoUrl;
      }
      updateParticipantsList(currentRoom.participants || []);
    }

    function openInviteModal() {
      document.getElementById('inviteModal').classList.add('active');
      document.getElementById('roomLink').value = `${window.location.origin}/room/${currentRoom.id}`;
    }

    function closeInviteModal() {
      document.getElementById('inviteModal').classList.remove('active');
    }

    async function copyRoomLink() {
      const linkInput = document.getElementById('roomLink');
      linkInput.select();
      try {
        await navigator.clipboard.writeText(linkInput.value);
        showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
      } catch (err) {
        showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
      }
    }

    function leaveRoom() {
      stopScreenShare();
      if (socket && currentRoom && currentUser) {
        socket.emit('leave-room', { roomId: currentRoom.id, userId: currentUser.id });
      }
      window.location.href = '/dashboard';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';
      setTimeout(() => { notification.style.display = 'none'; }, 3000);
    }

    function showLoading(text) {
      const overlay = document.getElementById('loadingOverlay');
      const textElement = document.getElementById('loadingText');
      if (overlay && textElement) {
        textElement.textContent = text;
        overlay.style.display = 'flex';
      }
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }

    window.leaveRoom = leaveRoom;
    window.openInviteModal = openInviteModal;
    window.closeInviteModal = closeInviteModal;
    window.copyRoomLink = copyRoomLink;
    window.stopScreenShare = stopScreenShare;
    window.togglePlayPause = togglePlayPause;
    window.toggleMute = toggleMute;
    window.toggleFullscreen = toggleFullscreen;
  </script>
</body>
</html>

