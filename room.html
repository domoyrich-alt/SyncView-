<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Комната просмотра - WatchParty</title>
    <link rel="stylesheet" href="style.css?v=4.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.10/dist/hls.min.js"></script>
    <style>
        /* Улучшенные стили для чата */
        .chat-message {
            display: flex;
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 10px;
            background: #f5f5f5;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .message-username {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .message-time {
            font-size: 12px;
            color: #888;
        }
        
        .message-text {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }
        
        /* Индикатор демонстрации экрана */
        .sharing-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border: 2px solid white;
        }
        
        .sharing-badge {
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        /* Уведомление о демонстрации экрана */
        .screen-share-notice {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        /* Стили для ссылок видео */
        .video-platform-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            margin: 5px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .video-platform-btn:hover {
            background: #e0e0e0;
        }
        
        .video-platforms {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="logo">
                <i class="fas fa-film"></i>
                <a href="/dashboard" style="text-decoration: none; color: inherit;">
                    <span>WatchParty</span>
                </a>
            </div>
            <div class="room-info-nav">
                <span id="roomNameNav">Загрузка...</span>
                <div class="room-status-nav">
                    <i class="fas fa-circle online"></i>
                    <span id="participantsCount">0</span> онлайн
                </div>
            </div>
            <div class="user-menu">
                <a href="/profile" class="user-profile-link">
                    <div class="user-avatar-nav" id="userAvatarNav"></div>
                    <span id="userNameNav"></span>
                </a>
                <button onclick="leaveRoom()" class="btn btn-outline btn-small">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </button>
            </div>
        </nav>

        <div class="room-container">
            <!-- Основной видеоплеер -->
            <div class="video-section">
                <div class="video-wrapper">
                    <video id="videoPlayer" controls playsinline>
                        Ваш браузер не поддерживает видео тег.
                    </video>
                    
                    <!-- Уведомление о демонстрации экрана -->
                    <div id="screenShareNotice" class="screen-share-notice" style="display: none;">
                        <i class="fas fa-desktop"></i>
                        <span id="screenShareText"></span>
                    </div>
                    
                    <div class="video-controls-overlay">
                        <div class="video-controls">
                            <button class="control-btn-large" id="playPauseBtn">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="time-display">
                                <span id="currentTime">00:00</span> / <span id="duration">00:00</span>
                            </div>
                            <input type="range" id="progressBar" class="progress-bar" min="0" max="100" value="0">
                            <div class="volume-control">
                                <button class="control-btn-small" id="muteBtn">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <input type="range" id="volumeBar" class="volume-bar" min="0" max="100" value="100">
                            </div>
                            <button class="control-btn-large" id="fullscreenBtn">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Платформы для быстрого выбора -->
                <div class="video-platforms">
                    <button class="video-platform-btn" data-platform="youtube">
                        <i class="fab fa-youtube" style="color: #FF0000;"></i> YouTube
                    </button>
                    <button class="video-platform-btn" data-platform="vimeo">
                        <i class="fab fa-vimeo" style="color: #1ab7ea;"></i> Vimeo
                    </button>
                    <button class="video-platform-btn" data-platform="twitch">
                        <i class="fab fa-twitch" style="color: #9146FF;"></i> Twitch
                    </button>
                </div>
                
                <div class="video-url-input">
                    <input type="url" id="videoUrlInput" placeholder="Вставьте ссылку на видео или выберите платформу выше">
                    <button class="btn btn-primary" id="loadVideoBtn">
                        <i class="fas fa-play"></i> Загрузить
                    </button>
                </div>
            </div>

            <!-- Боковая панель -->
            <div class="sidebar">
                <!-- Чат -->
                <div class="chat-container">
                    <div class="chat-header">
                        <h3><i class="fas fa-comments"></i> Чат комнаты</h3>
                        <div class="chat-actions">
                            <button class="btn-icon" id="clearChatBtn" title="Очистить чат">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- Сообщения будут добавляться через JavaScript -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="Введите сообщение..." maxlength="500">
                        <button class="btn btn-primary" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <!-- Участники -->
                <div class="participants-container">
                    <div class="participants-header">
                        <h3><i class="fas fa-users"></i> Участники</h3>
                        <span class="participants-count" id="participantsListCount">0</span>
                    </div>
                    <div class="participants-list" id="participantsList">
                        <!-- Участники будут добавляться через JavaScript -->
                    </div>
                </div>

                <!-- Звуковые эффекты -->
                <div class="sound-effects-panel">
                    <h3><i class="fas fa-music"></i> Звуковые эффекты</h3>
                    <div class="sound-effects-grid">
                        <button class="sound-effect-btn" data-sound="applause">
                            <i class="fas fa-hands-clapping"></i>
                            <span>Аплодисменты</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="laugh">
                            <i class="fas fa-face-laugh"></i>
                            <span>Смех</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="gasp">
                            <i class="fas fa-face-surprise"></i>
                            <span>Удивление</span>
                        </button>
                    </div>
                </div>

                <!-- Управление комнатой -->
                <div class="room-control-panel">
                    <h3><i class="fas fa-cog"></i> Управление комнатой</h3>
                    <div class="room-controls">
                        <button class="btn btn-outline btn-block" id="inviteBtn">
                            <i class="fas fa-user-plus"></i> Пригласить друзей
                        </button>
                        
                        <!-- Кнопка демонстрации экрана -->
                        <button class="btn btn-primary btn-block" id="screenShareBtn">
                            <i class="fas fa-desktop"></i> <span id="screenShareBtnText">Показать экран</span>
                        </button>
                        
                        <button class="btn btn-primary btn-block" id="syncBtn">
                            <i class="fas fa-sync-alt"></i> Синхронизировать видео
                        </button>
                        
                        <!-- Информация о демонстрации экрана -->
                        <div id="screenShareInfo" style="display: none; margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                            <p><i class="fas fa-info-circle"></i> <span id="screenShareInfoText"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно приглашения -->
    <div class="modal" id="inviteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Пригласить друзей</h3>
                <button class="modal-close" onclick="closeInviteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="invite-method">
                    <h4>Ссылка для приглашения</h4>
                    <div class="link-container">
                        <input type="text" id="roomLink" readonly>
                        <button class="btn btn-primary" id="copyLinkBtn">
                            <i class="fas fa-copy"></i> Копировать
                        </button>
                    </div>
                    <p class="hint">Отправьте эту ссылку друзьям</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div id="notification" class="notification" style="display: none;"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Глобальные переменные
        let socket = null;
        let currentRoom = null;
        let currentUser = null;
        let isHost = false;
        let videoPlayer = null;
        let hls = null;
        let lastSyncTime = 0;
        let autoSyncEnabled = true;
        let isSyncing = false;
        
        // Переменные для демонстрации экрана
        let screenStream = null;
        let screenShareActive = false;
        let currentScreenSharer = null;
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserData();
            await loadRoomData();
            initializeVideoPlayer();
            setupEventListeners();
            initializeSocket();
        });

        async function loadUserData() {
            try {
                const response = await fetch('/api/user');
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('userNameNav').textContent = currentUser.username;
                    const avatarNav = document.getElementById('userAvatarNav');
                    avatarNav.style.backgroundImage = `url('${currentUser.avatar}')`;
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                window.location.href = '/login';
            }
        }

        async function loadRoomData() {
            const roomId = window.location.pathname.split('/').pop();
            try {
                const response = await fetch(`/api/room/${roomId}`);
                const data = await response.json();
                if (data.success) {
                    currentRoom = data.room;
                    isHost = currentRoom.hostId === currentUser.id;
                    updateRoomUI();
                } else {
                    showNotification(data.error || 'Ошибка загрузки комнаты', 'error');
                    setTimeout(() => window.location.href = '/dashboard', 2000);
                }
            } catch (error) {
                showNotification('Ошибка соединения', 'error');
                setTimeout(() => window.location.href = '/dashboard', 2000);
            }
        }

        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('✅ WebSocket подключен');
                joinRoom();
            });

            socket.on('room-state', (data) => {
                console.log('Получено состояние комнаты:', data);
                updateParticipantsList(data.participants);
                loadChatMessages(data.messages);
                
                // Обновляем информацию о демонстрации экрана
                if (data.screenSharer) {
                    currentScreenSharer = data.screenSharer;
                    updateScreenShareUI();
                } else {
                    currentScreenSharer = null;
                    hideScreenShareUI();
                }
                
                if (data.videoState.url) {
                    loadVideo(data.videoState.url);
                    if (!isHost && data.videoState.isPlaying !== undefined) {
                        syncVideoWithServer(data.videoState);
                    }
                }
            });

            socket.on('user-joined', (data) => {
                showNotification(`${data.username} присоединился(ась) к комнате`, 'info');
                addSystemMessage(`${data.username} присоединился(ась) к комнате`);
            });

            socket.on('user-left', (data) => {
                showNotification('Пользователь покинул комнату', 'info');
                addSystemMessage('Пользователь покинул комнату');
            });

            socket.on('new-message', (message) => {
                addMessageToChat(message);
            });

            socket.on('video-update', (data) => {
                if (isHost) return;
                console.log('Получено обновление видео:', data);
                handleVideoUpdate(data);
            });

            socket.on('play-sound', (sound) => {
                playSoundEffect(sound);
            });

            socket.on('participants-updated', (participants) => {
                updateParticipantsList(participants);
            });

            // События демонстрации экрана
            socket.on('screen-share-start', (data) => {
                console.log('Начата демонстрация экрана:', data);
                currentScreenSharer = data;
                updateScreenShareUI();
                showNotification(`${data.username} начал демонстрацию экрана`, 'info');
                addSystemMessage(`${data.username} начал показ экрана`);
            });

            socket.on('screen-share-stop', (data) => {
                console.log('Остановлена демонстрация экрана:', data);
                currentScreenSharer = null;
                hideScreenShareUI();
                showNotification('Демонстрация экрана остановлена', 'info');
                addSystemMessage('Показ экрана остановлен');
            });

            socket.on('error', (data) => {
                showNotification(data.message, 'error');
            });

            socket.on('disconnect', () => {
                showNotification('Потеряно соединение с сервером', 'error');
            });
        }

        function joinRoom() {
            if (!socket || !currentRoom || !currentUser) return;
            socket.emit('join-room', {
                roomId: currentRoom.id,
                userId: currentUser.id,
                username: currentUser.username,
                avatar: currentUser.avatar
            });
        }

        function initializeVideoPlayer() {
            videoPlayer = document.getElementById('videoPlayer');
            
            videoPlayer.addEventListener('play', () => {
                if (isHost) {
                    sendVideoControl('play', videoPlayer.currentTime);
                }
            });
            
            videoPlayer.addEventListener('pause', () => {
                if (isHost) {
                    sendVideoControl('pause', videoPlayer.currentTime);
                }
            });
            
            videoPlayer.addEventListener('seeked', () => {
                if (isHost && !isSyncing) {
                    sendVideoControl('seek', videoPlayer.currentTime);
                }
            });
            
            videoPlayer.addEventListener('timeupdate', () => {
                updateTimeDisplay();
                if (!isHost && autoSyncEnabled && Date.now() - lastSyncTime > 10000) {
                    requestSync();
                }
            });
            
            if (Hls.isSupported()) {
                hls = new Hls();
            }
        }

        function setupEventListeners() {
            // Кнопки управления видео
            document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
            document.getElementById('muteBtn').addEventListener('click', toggleMute);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('progressBar').addEventListener('input', (e) => {
                if (!videoPlayer.duration) return;
                const time = (e.target.value / 100) * videoPlayer.duration;
                videoPlayer.currentTime = time;
            });
            document.getElementById('volumeBar').addEventListener('input', (e) => {
                videoPlayer.volume = e.target.value / 100;
                updateVolumeIcon();
            });

            // Кнопки платформ
            document.querySelectorAll('.video-platform-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const platform = btn.dataset.platform;
                    let placeholder = '';
                    switch(platform) {
                        case 'youtube':
                            placeholder = 'https://www.youtube.com/watch?v=...';
                            break;
                        case 'vimeo':
                            placeholder = 'https://vimeo.com/...';
                            break;
                        case 'twitch':
                            placeholder = 'https://www.twitch.tv/...';
                            break;
                    }
                    document.getElementById('videoUrlInput').placeholder = placeholder;
                    document.getElementById('videoUrlInput').focus();
                });
            });

            // Загрузка видео
            document.getElementById('loadVideoBtn').addEventListener('click', () => {
                const url = document.getElementById('videoUrlInput').value;
                if (url) {
                    loadVideo(url);
                    if (isHost) {
                        sendVideoControl('change-video', 0, url);
                    }
                }
            });
            
            document.getElementById('videoUrlInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('loadVideoBtn').click();
                }
            });

            // Чат
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('clearChatBtn').addEventListener('click', () => {
                if (confirm('Очистить всю историю чата?')) {
                    document.getElementById('chatMessages').innerHTML = '';
                }
            });

            // Звуковые эффекты
            document.querySelectorAll('.sound-effect-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sound = btn.dataset.sound;
                    playSoundEffect(sound);
                    socket.emit('sound-effect', { roomId: currentRoom.id, sound });
                });
            });

            // Управление комнатой
            document.getElementById('inviteBtn').addEventListener('click', openInviteModal);
            document.getElementById('syncBtn').addEventListener('click', requestSync);
            document.getElementById('screenShareBtn').addEventListener('click', toggleScreenShare);
            document.getElementById('copyLinkBtn').addEventListener('click', copyRoomLink);

            // Обработка закрытия страницы
            window.addEventListener('beforeunload', () => {
                if (socket) {
                    socket.emit('leave-room', { roomId: currentRoom.id, userId: currentUser.id });
                }
                stopScreenShare();
            });
        }

        // Функции управления видео
        function loadVideo(url) {
            if (!url) return;
            
            currentRoom.videoUrl = url;
            
            // Парсим ссылки разных платформ
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                loadYouTubeVideo(url);
            } else if (url.includes('vimeo.com')) {
                loadVimeoVideo(url);
            } else if (url.endsWith('.m3u8')) {
                loadHLSVideo(url);
            } else if (url.endsWith('.mp4') || url.endsWith('.webm') || url.endsWith('.ogg')) {
                loadDirectVideo(url);
            } else {
                showNotification('Формат видео не поддерживается', 'error');
            }
        }

        function loadDirectVideo(url) {
            videoPlayer.src = url;
            videoPlayer.load();
            showNotification('Видео загружается...', 'info');
        }

        function loadHLSVideo(url) {
            if (Hls.isSupported()) {
                if (hls) {
                    hls.destroy();
                }
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    videoPlayer.play();
                });
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                videoPlayer.src = url;
                videoPlayer.addEventListener('loadedmetadata', () => {
                    videoPlayer.play();
                });
            } else {
                showNotification('Ваш браузер не поддерживает HLS видео', 'error');
            }
        }

        function loadYouTubeVideo(url) {
            showNotification('YouTube видео загружается...', 'info');
            document.getElementById('videoUrlInput').value = url;
        }

        function loadVimeoVideo(url) {
            showNotification('Vimeo видео загружается...', 'info');
            document.getElementById('videoUrlInput').value = url;
        }

        function togglePlayPause() {
            if (videoPlayer.paused) {
                videoPlayer.play();
            } else {
                videoPlayer.pause();
            }
        }

        function toggleMute() {
            videoPlayer.muted = !videoPlayer.muted;
            updateVolumeIcon();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                videoPlayer.requestFullscreen().catch(err => {
                    console.log('Ошибка полноэкранного режима:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function updateTimeDisplay() {
            const currentTime = document.getElementById('currentTime');
            const duration = document.getElementById('duration');
            const progressBar = document.getElementById('progressBar');
            
            if (!isNaN(videoPlayer.duration)) {
                const currentMinutes = Math.floor(videoPlayer.currentTime / 60);
                const currentSeconds = Math.floor(videoPlayer.currentTime % 60);
                const durationMinutes = Math.floor(videoPlayer.duration / 60);
                const durationSeconds = Math.floor(videoPlayer.duration % 60);
                
                currentTime.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
                duration.textContent = `${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
                progressBar.value = (videoPlayer.currentTime / videoPlayer.duration) * 100;
            }
        }

        function updateVolumeIcon() {
            const muteBtn = document.getElementById('muteBtn');
            const volumeBar = document.getElementById('volumeBar');
            
            if (videoPlayer.muted || videoPlayer.volume === 0) {
                muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                volumeBar.value = 0;
            } else if (videoPlayer.volume < 0.5) {
                muteBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
                volumeBar.value = videoPlayer.volume * 100;
            } else {
                muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                volumeBar.value = videoPlayer.volume * 100;
            }
        }

        // Функции чата
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message || !socket) return;
            
            socket.emit('send-message', {
                roomId: currentRoom.id,
                userId: currentUser.id,
                message: message
            });
            input.value = '';
            input.focus();
        }

        function addMessageToChat(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            const time = new Date(message.timestamp);
            const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            
            messageElement.innerHTML = `
                <div class="message-avatar">
                    <img src="${message.avatar}" alt="${message.username}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-username">${escapeHtml(message.username)}</span>
                        <span class="message-time">${timeString}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message.message)}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message system';
            
            const time = new Date();
            const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-username"><i class="fas fa-info-circle"></i> Система</span>
                        <span class="message-time">${timeString}</span>
                    </div>
                    <div class="message-text">${text}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function loadChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            messages.forEach(message => {
                addMessageToChat(message);
            });
        }

        // Функции участников
        function updateParticipantsList(participants) {
            const participantsList = document.getElementById('participantsList');
            const participantsCount = document.getElementById('participantsCount');
            const participantsListCount = document.getElementById('participantsListCount');
            
            participantsList.innerHTML = '';
            participantsCount.textContent = participants.length;
            participantsListCount.textContent = participants.length;
            
            participants.forEach(participant => {
                const isSharing = participant.isSharingScreen || 
                    (currentScreenSharer && participant.id === currentScreenSharer.userId);
                const isCurrentUser = participant.id === currentUser.id;
                
                const participantElement = document.createElement('div');
                participantElement.className = 'participant-item';
                participantElement.innerHTML = `
                    <div class="participant-avatar">
                        <img src="${participant.avatar}" alt="${participant.username}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
                        ${isSharing ? '<div class="sharing-indicator"><i class="fas fa-desktop"></i></div>' : ''}
                    </div>
                    <div class="participant-info">
                        <div class="participant-name">
                            ${participant.username}
                            ${isCurrentUser ? '<span class="you-badge">Вы</span>' : ''}
                            ${isSharing ? '<span class="sharing-badge">Демонстрирует</span>' : ''}
                        </div>
                        ${participant.id === currentRoom.hostId ? '<div class="participant-host">Хост</div>' : '<div class="participant-role">Участник</div>'}
                    </div>
                `;
                
                participantsList.appendChild(participantElement);
            });
        }

        // Функции демонстрации экрана
        function toggleScreenShare() {
            if (!screenShareActive) {
                startScreenShare();
            } else {
                stopScreenShare();
            }
        }

        async function startScreenShare() {
            try {
                showNotification('Запрашиваю доступ к экрану...', 'info');
                
                const constraints = {
                    video: {
                        cursor: "always",
                        frameRate: 15,
                        width: { max: 1920 },
                        height: { max: 1080 }
                    },
                    audio: true
                };
                
                screenStream = await navigator.mediaDevices.getDisplayMedia(constraints);
                
                // Обработчик прекращения трансляции
                screenStream.getVideoTracks()[0].onended = () => {
                    stopScreenShare();
                };
                
                // Отображаем экран в видео-плеере
                videoPlayer.srcObject = screenStream;
                videoPlayer.muted = true;
                
                // Обновляем UI
                document.getElementById('screenShareBtnText').textContent = 'Остановить показ';
                document.getElementById('screenShareBtn').classList.remove('btn-primary');
                document.getElementById('screenShareBtn').classList.add('btn-danger');
                
                // Отправляем уведомление о начале показа экрана
                socket.emit('screen-share-start', {
                    roomId: currentRoom.id,
                    userId: currentUser.id,
                    username: currentUser.username,
                    quality: 'medium',
                    delay: 100
                });
                
                screenShareActive = true;
                showNotification('Показ экрана начат', 'success');
                
            } catch (error) {
                console.error('Ошибка при показе экрана:', error);
                showNotification('Не удалось начать показ экрана', 'error');
                if (error.name === 'NotAllowedError') {
                    showNotification('Доступ к экрану отклонен', 'error');
                }
            }
        }

        function stopScreenShare() {
            if (screenShareActive) {
                screenShareActive = false;
                
                // Останавливаем поток
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                    screenStream = null;
                }
                
                // Возвращаем видео плеер в исходное состояние
                videoPlayer.srcObject = null;
                
                // Обновляем UI
                document.getElementById('screenShareBtnText').textContent = 'Показать экран';
                document.getElementById('screenShareBtn').classList.remove('btn-danger');
                document.getElementById('screenShareBtn').classList.add('btn-primary');
                
                // Отправляем сообщение об остановке
                socket.emit('screen-share-stop', {
                    roomId: currentRoom.id,
                    userId: currentUser.id
                });
                
                showNotification('Показ экрана остановлен', 'info');
            }
        }

        function updateScreenShareUI() {
            if (currentScreenSharer) {
                const isCurrentUser = currentScreenSharer.userId === currentUser.id;
                const screenShareNotice = document.getElementById('screenShareNotice');
                const screenShareInfo = document.getElementById('screenShareInfo');
                
                if (isCurrentUser) {
                    // Это наш экран
                    screenShareNotice.style.display = 'flex';
                    document.getElementById('screenShareText').textContent = 'Вы демонстрируете экран';
                    
                    screenShareInfo.style.display = 'block';
                    document.getElementById('screenShareInfoText').textContent = 'Вы демонстрируете экран другим участникам';
                } else {
                    // Это чужой экран
                    screenShareNotice.style.display = 'flex';
                    document.getElementById('screenShareText').textContent = `${currentScreenSharer.username} демонстрирует экран`;
                    
                    screenShareInfo.style.display = 'block';
                    document.getElementById('screenShareInfoText').textContent = `${currentScreenSharer.username} демонстрирует экран`;
                }
            }
        }

        function hideScreenShareUI() {
            document.getElementById('screenShareNotice').style.display = 'none';
            document.getElementById('screenShareInfo').style.display = 'none';
        }

        // Функции синхронизации
        function sendVideoControl(action, time, url) {
            if (!socket) return;
            socket.emit('video-control', {
                roomId: currentRoom.id,
                action: action,
                time: time,
                url: url
            });
            lastSyncTime = Date.now();
        }

        function handleVideoUpdate(data) {
            isSyncing = true;
            switch(data.action) {
                case 'play':
                    if (Math.abs(videoPlayer.currentTime - data.time) > 2) {
                        videoPlayer.currentTime = data.time;
                    }
                    videoPlayer.play().catch(e => console.log('Ошибка воспроизведения:', e));
                    break;
                case 'pause':
                    videoPlayer.pause();
                    if (Math.abs(videoPlayer.currentTime - data.time) > 2) {
                        videoPlayer.currentTime = data.time;
                    }
                    break;
                case 'seek':
                    videoPlayer.currentTime = data.time;
                    break;
                case 'change-video':
                    loadVideo(data.url);
                    break;
            }
            setTimeout(() => { isSyncing = false; }, 100);
        }

        function requestSync() {
            if (!socket || !isHost) return;
            socket.emit('video-control', {
                roomId: currentRoom.id,
                action: videoPlayer.paused ? 'pause' : 'play',
                time: videoPlayer.currentTime
            });
            lastSyncTime = Date.now();
            showNotification('Видео синхронизировано', 'info');
        }

        // Звуковые эффекты
        function playSoundEffect(sound) {
            const audio = new Audio();
            switch(sound) {
                case 'applause':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-audience-light-applause-354.mp3';
                    break;
                case 'laugh':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-crowd-laugh-464.mp3';
                    break;
                case 'gasp':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-crowd-gasp-390.mp3';
                    break;
                case 'boo':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-boo-crowd-461.mp3';
                    break;
                case 'drumroll':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-drum-roll-473.mp3';
                    break;
                case 'sad':
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-sad-crowd-492.mp3';
                    break;
            }
            audio.volume = 0.3;
            audio.play().catch(e => console.log('Ошибка воспроизведения звука:', e));
        }

        // Функции UI
        function updateRoomUI() {
            document.getElementById('roomNameNav').textContent = currentRoom.name;
            document.title = `${currentRoom.name} - WatchParty`;
            
            if (currentRoom.videoUrl) {
                document.getElementById('videoUrlInput').value = currentRoom.videoUrl;
                loadVideo(currentRoom.videoUrl);
            }
            
            updateParticipantsList(currentRoom.participants || []);
        }

        function openInviteModal() {
            document.getElementById('inviteModal').classList.add('active');
            document.getElementById('roomLink').value = `${window.location.origin}/room/${currentRoom.id}`;
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').classList.remove('active');
        }

        async function copyRoomLink() {
            const linkInput = document.getElementById('roomLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            try {
                await navigator.clipboard.writeText(linkInput.value);
                showNotification('Ссылка скопирована в буфер обмена!', 'success');
            } catch (err) {
                showNotification('Ошибка копирования', 'error');
            }
        }

        function leaveRoom() {
            stopScreenShare();
            if (socket) {
                socket.emit('leave-room', { roomId: currentRoom.id, userId: currentUser.id });
            }
            window.location.href = '/dashboard';
        }

        // Вспомогательные функции
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Экспорт функций для глобального использования
        window.togglePlayPause = togglePlayPause;
        window.toggleMute = toggleMute;
        window.toggleFullscreen = toggleFullscreen;
        window.sendMessage = sendMessage;
        window.leaveRoom = leaveRoom;
        window.openInviteModal = openInviteModal;
        window.closeInviteModal = closeInviteModal;
        window.copyRoomLink = copyRoomLink;
        window.requestSync = requestSync;
        window.toggleScreenShare = toggleScreenShare;
    </script>
</body>
</html>
