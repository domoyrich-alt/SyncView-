<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–ö–æ–º–Ω–∞—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - WatchParty</title>
    <link rel="stylesheet" href="style.css?v=3.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.10/dist/hls.min.js"></script>
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç—ã...</p>
    </div>

    <div class="container">
        <nav class="navbar">
            <div class="logo">
                <i class="fas fa-film"></i>
                <a href="/dashboard" style="text-decoration: none; color: inherit;">
                    <span>WatchParty</span>
                </a>
            </div>
            <div class="room-info-nav">
                <span id="roomNameNav">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                <div class="room-status-nav">
                    <i class="fas fa-circle online"></i>
                    <span id="participantsCount">0</span> –æ–Ω–ª–∞–π–Ω
                </div>
            </div>
            <div class="user-menu">
                <a href="/profile" class="user-profile-link">
                    <div class="user-avatar-nav" id="userAvatarNav"></div>
                    <span id="userNameNav"></span>
                </a>
                <button onclick="leaveRoom()" class="btn btn-outline btn-small">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                </button>
            </div>
        </nav>

        <div class="room-container">
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä -->
            <div class="video-section">
                <div class="video-wrapper">
                    <video id="videoPlayer" controls playsinline>
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.
                    </video>
                    <div class="video-controls-overlay">
                        <div class="video-controls">
                            <button class="control-btn-large" id="playPauseBtn">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="time-display">
                                <span id="currentTime">00:00</span> / <span id="duration">00:00</span>
                            </div>
                            <input type="range" id="progressBar" class="progress-bar" min="0" max="100" value="0">
                            <div class="volume-control">
                                <button class="control-btn-small" id="muteBtn">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <input type="range" id="volumeBar" class="volume-bar" min="0" max="100" value="100">
                            </div>
                            <button class="control-btn-large" id="fullscreenBtn">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="video-url-input">
                    <input type="url" id="videoUrlInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (YouTube, Vimeo, MP4, M3U8)">
                    <button class="btn btn-primary" id="loadVideoBtn">
                        <i class="fas fa-play"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                </div>
            </div>

            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="sidebar">
                <!-- –ß–∞—Ç -->
                <div class="chat-container">
                    <div class="chat-header">
                        <h3><i class="fas fa-comments"></i> –ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã</h3>
                        <div class="chat-actions">
                            <button class="btn-icon" id="clearChatBtn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="system-message">
                            <i class="fas fa-info-circle"></i> –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç –∫–æ–º–Ω–∞—Ç—ã!
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
                        <button class="btn btn-primary" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
                <div class="participants-container">
                    <div class="participants-header">
                        <h3><i class="fas fa-users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                        <span class="participants-count" id="participantsListCount">0</span>
                    </div>
                    <div class="participants-list" id="participantsList">
                        <div class="participant-placeholder">
                            <i class="fas fa-user-clock"></i>
                            <p>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
                        </div>
                    </div>
                </div>

                <!-- –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
                <div class="sound-effects-panel">
                    <h3><i class="fas fa-music"></i> –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</h3>
                    <div class="sound-effects-grid">
                        <button class="sound-effect-btn" data-sound="applause">
                            <i class="fas fa-hands-clapping"></i>
                            <span>–ê–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç—ã</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="laugh">
                            <i class="fas fa-face-laugh"></i>
                            <span>–°–º–µ—Ö</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="gasp">
                            <i class="fas fa-face-surprise"></i>
                            <span>–£–¥–∏–≤–ª–µ–Ω–∏–µ</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="boo">
                            <i class="fas fa-face-angry"></i>
                            <span>–ù–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="drumroll">
                            <i class="fas fa-drum"></i>
                            <span>–ë–∞—Ä–∞–±–∞–Ω–Ω–∞—è –¥—Ä–æ–±—å</span>
                        </button>
                        <button class="sound-effect-btn" data-sound="sad">
                            <i class="fas fa-face-sad-cry"></i>
                            <span>–ì—Ä—É—Å—Ç—å</span>
                        </button>
                    </div>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–æ–π -->
                <div class="room-control-panel">
                    <h3><i class="fas fa-cog"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–æ–π</h3>
                    <div class="room-controls">
                        <button class="btn btn-outline btn-block" id="inviteBtn">
                            <i class="fas fa-user-plus"></i> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π
                        </button>
                        
                        <!-- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞ -->
                        <button class="btn btn-primary btn-block" id="screenShareBtn">
                            <i class="fas fa-desktop"></i> –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
                        </button>
                        
                        <button class="btn btn-primary btn-block" id="syncBtn">
                            <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ
                        </button>
                        
                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
                        <div class="sync-options">
                            <label class="setting">
                                <input type="checkbox" id="autoSync" checked>
                                <span class="checkmark"></span>
                                –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                            </label>
                            <label class="setting">
                                <input type="checkbox" id="syncAudio" checked>
                                <span class="checkmark"></span>
                                –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–≤—É–∫
                            </label>
                            <label class="setting">
                                <input type="checkbox" id="showControlBar" checked>
                                <span class="checkmark"></span>
                                –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                            </label>
                        </div>
                        
                        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞ -->
                        <div class="sync-params">
                            <div class="sync-param">
                                <label for="syncDelay">–ó–∞–¥–µ—Ä–∂–∫–∞ (–º—Å):</label>
                                <input type="number" id="syncDelay" min="100" max="2000" value="500" step="100">
                            </div>
                            <div class="sync-param">
                                <label for="syncQuality">–ö–∞—á–µ—Å—Ç–≤–æ:</label>
                                <select id="syncQuality">
                                    <option value="low">–ù–∏–∑–∫–æ–µ</option>
                                    <option value="medium" selected>–°—Ä–µ–¥–Ω–µ–µ</option>
                                    <option value="high">–í—ã—Å–æ–∫–æ–µ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
    <div class="modal" id="inviteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</h3>
                <button class="modal-close" onclick="closeInviteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="invite-method">
                    <h4>–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h4>
                    <div class="link-container">
                        <input type="text" id="roomLink" readonly>
                        <button class="btn btn-primary" id="copyLinkBtn">
                            <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                    <p class="hint">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º, —á—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞ -->
    <div class="sync-notification" id="syncNotification" style="display: none;">
        <div class="sync-indicator">
            <i class="fas fa-desktop"></i>
            <span id="syncIndicatorText">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
        </div>
        <div class="sync-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="syncProgress"></div>
            </div>
            <span id="syncLatency">0–º—Å</span>
        </div>
        <button class="btn-icon" onclick="stopScreenShare()" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞">
            <i class="fas fa-stop"></i>
        </button>
    </div>

    <div id="notification" class="notification" style="display: none;"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è script.js –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket = null;
        let currentRoom = null;
        let currentUser = null;
        let isHost = false;
        let videoPlayer = null;
        let hls = null;
        let lastSyncTime = 0;
        let autoSyncEnabled = true;
        let isSyncing = false;
        let screenShareActive = false;
        let screenStream = null;
        let syncInterval = null;
        let progressInterval = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            await loadUserData();
            showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç—ã...');
            await loadRoomData();
            initializeVideoPlayer();
            setupEventListeners();
            showLoading('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...');
            initializeSocket();
        });

        async function loadUserData() {
            try {
                const response = await fetch('/api/user');
                if (!response.ok) {
                    throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                }
                
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('userNameNav').textContent = currentUser.username;
                    
                    const avatarNav = document.getElementById('userAvatarNav');
                    if (currentUser.avatar) {
                        avatarNav.style.backgroundImage = `url('${currentUser.avatar}')`;
                        avatarNav.style.backgroundSize = 'cover';
                        avatarNav.style.backgroundPosition = 'center';
                    }
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                window.location.href = '/login';
            }
        }

        async function loadRoomData() {
            const roomId = window.location.pathname.split('/').pop();
            
            try {
                const response = await fetch(`/api/room/${roomId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentRoom = data.room;
                    isHost = currentRoom.hostId === currentUser.id;
                    updateRoomUI();
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç—ã', 'error');
                    setTimeout(() => window.location.href = '/dashboard', 2000);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç—ã:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                setTimeout(() => window.location.href = '/dashboard', 2000);
            }
        }

        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                hideLoading();
                joinRoom();
            });
            
            socket.on('room-state', (data) => {
                console.log('üì¶ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã');
                updateParticipantsList(data.participants);
                loadChatMessages(data.messages);
                
                if (data.videoState.url && data.videoState.url !== currentRoom.videoUrl) {
                    loadVideo(data.videoState.url);
                }
                
                if (!isHost && data.videoState.isPlaying !== undefined) {
                    syncVideoWithServer(data.videoState);
                }
            });
            
            socket.on('user-joined', (data) => {
                showNotification(`${data.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è(–∞—Å—å)`, 'info');
                addSystemMessage(`${data.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è(–∞—Å—å) –∫ –∫–æ–º–Ω–∞—Ç–µ`);
            });
            
            socket.on('user-left', (data) => {
                addSystemMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É');
            });
            
            socket.on('new-message', (message) => {
                addMessageToChat(message);
            });
            
            socket.on('video-update', (data) => {
                if (isHost) return;
                handleVideoUpdate(data);
            });
            
            socket.on('play-sound', (sound) => {
                playSoundEffect(sound);
            });
            
            socket.on('participants-updated', (participants) => {
                updateParticipantsList(participants);
            });
            
            socket.on('error', (data) => {
                showNotification(data.message, 'error');
            });
            
            socket.on('connect_error', (error) => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            });
        }

        function joinRoom() {
            if (!socket || !currentRoom || !currentUser) return;
            
            socket.emit('join-room', {
                roomId: currentRoom.id,
                userId: currentUser.id,
                username: currentUser.username,
                avatar: currentUser.avatar
            });
        }

        function initializeVideoPlayer() {
            videoPlayer = document.getElementById('videoPlayer');
            
            videoPlayer.addEventListener('play', () => {
                if (isHost) {
                    sendVideoControl('play', videoPlayer.currentTime);
                }
            });
            
            videoPlayer.addEventListener('pause', () => {
                if (isHost) {
                    sendVideoControl('pause', videoPlayer.currentTime);
                }
            });
            
            videoPlayer.addEventListener('seeked', () => {
                if (isHost && !isSyncing) {
                    sendVideoControl('seek', videoPlayer.currentTime);
                }
            });
            
            videoPlayer.addEventListener('timeupdate', () => {
                updateTimeDisplay();
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HLS.js
            if (Hls && Hls.isSupported()) {
                hls = new Hls({
                    enableWorker: false // –û—Ç–∫–ª—é—á–∞–µ–º worker –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                });
            }
        }

        function setupEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ
            document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
            document.getElementById('muteBtn').addEventListener('click', toggleMute);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            
            document.getElementById('progressBar').addEventListener('input', (e) => {
                if (!videoPlayer.duration) return;
                const time = (e.target.value / 100) * videoPlayer.duration;
                videoPlayer.currentTime = time;
            });
            
            document.getElementById('volumeBar').addEventListener('input', (e) => {
                videoPlayer.volume = e.target.value / 100;
                updateVolumeIcon();
            });
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
            document.getElementById('loadVideoBtn').addEventListener('click', () => {
                const url = document.getElementById('videoUrlInput').value;
                if (url) {
                    loadVideo(url);
                    if (isHost) {
                        sendVideoControl('change-video', 0, url);
                    }
                }
            });
            
            // –ß–∞—Ç
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            document.querySelectorAll('.sound-effect-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sound = btn.dataset.sound;
                    playSoundEffect(sound);
                    if (socket && currentRoom) {
                        socket.emit('sound-effect', { roomId: currentRoom.id, sound });
                    }
                });
            });
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–æ–π
            document.getElementById('inviteBtn').addEventListener('click', openInviteModal);
            document.getElementById('syncBtn').addEventListener('click', requestSync);
            document.getElementById('screenShareBtn').addEventListener('click', toggleScreenShare);
            document.getElementById('copyLinkBtn').addEventListener('click', copyRoomLink);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', () => {
                if (socket && currentRoom && currentUser) {
                    socket.emit('leave-room', {
                        roomId: currentRoom.id,
                        userId: currentUser.id
                    });
                }
                stopScreenShare();
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ
        function loadVideo(url) {
            if (!url) return;
            
            currentRoom.videoUrl = url;
            showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...', 'info');
            
            try {
                if (url.includes('.m3u8') && hls) {
                    // HLS –≤–∏–¥–µ–æ
                    hls.loadSource(url);
                    hls.attachMedia(videoPlayer);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        videoPlayer.play();
                    });
                } else {
                    // –ü—Ä—è–º–æ–µ –≤–∏–¥–µ–æ (MP4, WebM)
                    videoPlayer.src = url;
                    videoPlayer.load();
                    videoPlayer.play().catch(e => {
                        console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ:', e);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ', 'error');
            }
        }

        function togglePlayPause() {
            if (videoPlayer.paused) {
                videoPlayer.play();
            } else {
                videoPlayer.pause();
            }
        }

        function toggleMute() {
            videoPlayer.muted = !videoPlayer.muted;
            updateVolumeIcon();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                videoPlayer.requestFullscreen().catch(err => {
                    console.log('–û—à–∏–±–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function updateTimeDisplay() {
            const currentTime = document.getElementById('currentTime');
            const duration = document.getElementById('duration');
            const progressBar = document.getElementById('progressBar');
            
            if (!isNaN(videoPlayer.duration)) {
                const currentMinutes = Math.floor(videoPlayer.currentTime / 60);
                const currentSeconds = Math.floor(videoPlayer.currentTime % 60);
                const durationMinutes = Math.floor(videoPlayer.duration / 60);
                const durationSeconds = Math.floor(videoPlayer.duration % 60);
                
                currentTime.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
                duration.textContent = `${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
                progressBar.value = (videoPlayer.currentTime / videoPlayer.duration) * 100;
            }
        }

        function updateVolumeIcon() {
            const muteBtn = document.getElementById('muteBtn');
            if (videoPlayer.muted || videoPlayer.volume === 0) {
                muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            } else if (videoPlayer.volume < 0.5) {
                muteBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
            } else {
                muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !socket) return;
            
            socket.emit('send-message', {
                roomId: currentRoom.id,
                userId: currentUser.id,
                message: message
            });
            
            input.value = '';
            input.focus();
        }

        function addMessageToChat(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            const time = new Date(message.timestamp);
            const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            
            messageElement.innerHTML = `
                <div class="message-avatar">
                    <img src="${message.avatar}" alt="${message.username}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-username">${escapeHtml(message.username)}</span>
                        <span class="message-time">${timeString}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message.message)}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message system';
            
            const time = new Date();
            const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-username"><i class="fas fa-info-circle"></i> –°–∏—Å—Ç–µ–º–∞</span>
                        <span class="message-time">${timeString}</span>
                    </div>
                    <div class="message-text">${escapeHtml(text)}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function loadChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '<div class="system-message"><i class="fas fa-info-circle"></i> –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç –∫–æ–º–Ω–∞—Ç—ã!</div>';
            
            messages.forEach(message => {
                addMessageToChat(message);
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function updateParticipantsList(participants) {
            const participantsList = document.getElementById('participantsList');
            const participantsCount = document.getElementById('participantsCount');
            const participantsListCount = document.getElementById('participantsListCount');
            
            participantsList.innerHTML = '';
            participantsCount.textContent = participants.length;
            participantsListCount.textContent = participants.length;
            
            participants.forEach(participant => {
                const isCurrentUser = participant.id === currentUser.id;
                
                const participantElement = document.createElement('div');
                participantElement.className = 'participant-item';
                participantElement.innerHTML = `
                    <div class="participant-avatar">
                        <img src="${participant.avatar}" alt="${participant.username}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
                    </div>
                    <div class="participant-info">
                        <div class="participant-name">
                            ${escapeHtml(participant.username)}
                            ${isCurrentUser ? '<span class="you-badge">–í—ã</span>' : ''}
                        </div>
                        <div class="participant-role">
                            ${participant.id === currentRoom.hostId ? '–•–æ—Å—Ç' : '–£—á–∞—Å—Ç–Ω–∏–∫'}
                        </div>
                    </div>
                `;
                participantsList.appendChild(participantElement);
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function sendVideoControl(action, time, url) {
            if (!socket) return;
            
            socket.emit('video-control', {
                roomId: currentRoom.id,
                action: action,
                time: time,
                url: url
            });
            
            lastSyncTime = Date.now();
        }

        function handleVideoUpdate(data) {
            isSyncing = true;
            
            switch(data.action) {
                case 'play':
                    if (Math.abs(videoPlayer.currentTime - data.time) > 2) {
                        videoPlayer.currentTime = data.time;
                    }
                    videoPlayer.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
                    break;
                case 'pause':
                    videoPlayer.pause();
                    if (Math.abs(videoPlayer.currentTime - data.time) > 2) {
                        videoPlayer.currentTime = data.time;
                    }
                    break;
                case 'seek':
                    videoPlayer.currentTime = data.time;
                    break;
                case 'change-video':
                    loadVideo(data.url);
                    break;
            }
            
            setTimeout(() => {
                isSyncing = false;
            }, 100);
        }

        function syncVideoWithServer(videoState) {
            if (isHost) return;
            
            if (Math.abs(videoPlayer.currentTime - videoState.currentTime) > 2) {
                videoPlayer.currentTime = videoState.currentTime;
            }
            
            if (videoState.isPlaying && videoPlayer.paused) {
                videoPlayer.play().catch(e => console.log('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', e));
            } else if (!videoState.isPlaying && !videoPlayer.paused) {
                videoPlayer.pause();
            }
        }

        function requestSync() {
            if (!socket || !isHost) return;
            
            socket.emit('video-control', {
                roomId: currentRoom.id,
                action: videoPlayer.paused ? 'pause' : 'play',
                time: videoPlayer.currentTime
            });
            
            lastSyncTime = Date.now();
            showNotification('–í–∏–¥–µ–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'success');
        }

        // –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        function playSoundEffect(sound) {
            const sounds = {
                applause: 'https://assets.mixkit.co/sfx/preview/mixkit-audience-light-applause-354.mp3',
                laugh: 'https://assets.mixkit.co/sfx/preview/mixkit-crowd-laugh-464.mp3',
                gasp: 'https://assets.mixkit.co/sfx/preview/mixkit-crowd-gasp-390.mp3',
                boo: 'https://assets.mixkit.co/sfx/preview/mixkit-boo-crowd-461.mp3',
                drumroll: 'https://assets.mixkit.co/sfx/preview/mixkit-drum-roll-473.mp3',
                sad: 'https://assets.mixkit.co/sfx/preview/mixkit-sad-crowd-492.mp3'
            };
            
            if (sounds[sound]) {
                const audio = new Audio(sounds[sound]);
                audio.volume = 0.3;
                audio.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', e));
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        async function toggleScreenShare() {
            if (!screenShareActive) {
                await startScreenShare();
            } else {
                stopScreenShare();
            }
        }

        async function startScreenShare() {
            try {
                showNotification('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —ç–∫—Ä–∞–Ω—É...', 'info');
                
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: document.getElementById('syncAudio').checked
                });
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —ç–∫—Ä–∞–Ω –≤ –≤–∏–¥–µ–æ-–ø–ª–µ–µ—Ä–µ
                videoPlayer.srcObject = screenStream;
                videoPlayer.muted = true;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('screenShareBtn').innerHTML = '<i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∫–∞–∑';
                document.getElementById('screenShareBtn').classList.remove('btn-primary');
                document.getElementById('screenShareBtn').classList.add('btn-danger');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                document.getElementById('syncIndicatorText').textContent = '–í—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç–µ —ç–∫—Ä–∞–Ω';
                document.getElementById('syncNotification').style.display = 'flex';
                startProgressAnimation();
                
                screenShareActive = true;
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏
                screenStream.getVideoTracks()[0].onended = () => {
                    stopScreenShare();
                };
                
                showNotification('–ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –Ω–∞—á–∞—Ç', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —ç–∫—Ä–∞–Ω–∞:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –ø–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞', 'error');
            }
        }

        function stopScreenShare() {
            if (screenShareActive) {
                screenShareActive = false;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                    screenStream = null;
                }
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–µ–æ –ø–ª–µ–µ—Ä –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                videoPlayer.srcObject = null;
                if (currentRoom.videoUrl) {
                    loadVideo(currentRoom.videoUrl);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('screenShareBtn').innerHTML = '<i class="fas fa-desktop"></i> –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω';
                document.getElementById('screenShareBtn').classList.remove('btn-danger');
                document.getElementById('screenShareBtn').classList.add('btn-primary');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                document.getElementById('syncNotification').style.display = 'none';
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
                showNotification('–ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
            }
        }

        function startProgressAnimation() {
            let progress = 0;
            const progressBar = document.getElementById('syncProgress');
            
            if (progressInterval) clearInterval(progressInterval);
            
            progressInterval = setInterval(() => {
                progress = (progress + 5) % 100;
                progressBar.style.width = `${progress}%`;
            }, 100);
        }

        // –§—É–Ω–∫—Ü–∏–∏ UI
        function updateRoomUI() {
            document.getElementById('roomNameNav').textContent = currentRoom.name;
            document.title = `${currentRoom.name} - WatchParty`;
            
            if (currentRoom.videoUrl) {
                document.getElementById('videoUrlInput').value = currentRoom.videoUrl;
            }
            
            updateParticipantsList(currentRoom.participants || []);
        }

        function openInviteModal() {
            document.getElementById('inviteModal').classList.add('active');
            document.getElementById('roomLink').value = `${window.location.origin}/room/${currentRoom.id}`;
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').classList.remove('active');
        }

        async function copyRoomLink() {
            const linkInput = document.getElementById('roomLink');
            linkInput.select();
            
            try {
                await navigator.clipboard.writeText(linkInput.value);
                showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
            } catch (err) {
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            }
        }

        function leaveRoom() {
            stopScreenShare();
            
            if (socket && currentRoom && currentUser) {
                socket.emit('leave-room', {
                    roomId: currentRoom.id,
                    userId: currentUser.id
                });
            }
            window.location.href = '/dashboard';
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function showLoading(text) {
            const overlay = document.getElementById('loadingOverlay');
            const textElement = document.getElementById('loadingText');
            if (overlay && textElement) {
                textElement.textContent = text;
                overlay.style.display = 'flex';
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        window.leaveRoom = leaveRoom;
        window.openInviteModal = openInviteModal;
        window.closeInviteModal = closeInviteModal;
        window.copyRoomLink = copyRoomLink;
        window.stopScreenShare = stopScreenShare;
        window.togglePlayPause = togglePlayPause;
        window.toggleMute = toggleMute;
        window.toggleFullscreen = toggleFullscreen;
    </script>
</body>
</html>